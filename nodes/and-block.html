<script type="text/html" data-template-name="and-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-slots" title="Number of boolean inputs (integer ≥ 2)"><i class="fa fa-list"></i> Slots</label>
        <input type="number" id="node-input-slots" placeholder="2" min="2" step="1">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("and-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            slots: { 
                value: 2, 
                required: true, 
                validate: function(v) { return Number.isInteger(+v) && +v >= 2; } 
            }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output"],
        icon: "font-awesome/fa-check-square-o",
        paletteLabel: "and",
        label: function() {
            return this.name ? `${this.name} (${this.slots})` : `and (${this.slots})`;
        },
        oneditprepare: function() {
            const node = this;

            // Initialize inputs
            $("#node-input-name").val(node.name || "");
            $("#node-input-slots").val(node.slots || 2);

            // Validate slots input
            $("#node-input-slots").on("input", function() {
                const val = parseInt($(this).val(), 10);
                if (!Number.isInteger(val) || val < 2) {
                    $(this).addClass("input-error");
                } else {
                    $(this).removeClass("input-error");
                }
            });

            // Fetch runtime changes
            $.getJSON(`/and-block-runtime/${node.id}`, function(data) {
                const runtime = data || {};
                const changes = [];
                if (runtime.name !== undefined && runtime.name !== node.name) {
                    changes.push(`name: ${runtime.name}`);
                }
                if (runtime.slots !== undefined && runtime.slots !== Number(node.slots)) {
                    changes.push(`slots: ${runtime.slots}`);
                }
                if (runtime.inputs && Array.isArray(runtime.inputs)) {
                    runtime.inputs.forEach((value, index) => {
                        if (value !== false) { // Only show non-default values
                            changes.push(`in${index + 1}: ${value}`);
                        }
                    });
                }
                const displayText = changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None";
                $("#node-runtime-changes").text(displayText);
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: None");
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved
        },
        oneditvalidate: function() {
            const slots = parseInt($("#node-input-slots").val(), 10);
            if (!Number.isInteger(slots) || slots < 2) {
                $("#node-input-slots").addClass("input-error");
                return false;
            }
            return true;
        }
    });
</script>

<script type="text/markdown" data-help-name="and-block">
Computes the logical AND of multiple boolean inputs, outputting a new message with the result.

### Inputs
: context (string) : Identifies the input slot (e.g., `"in1"`, `"in2"`).
: payload (any) : Value for the slot, converted to boolean (`true`, `1` → `true`; `false`, `0`, `null` → `false`).

### Outputs
: payload (boolean) : `true` if all slots are `true`, `false` otherwise.

### Details
Evaluates the logical AND of a fixed number of boolean inputs (`slots` ≥ 2, set in editor). Each slot is updated via `msg.context = "inX"` (e.g., `"in1"`, `"in2"`) with `msg.payload` converted to boolean. Outputs `{ payload: boolean }` with the AND result whenever a valid input updates a slot. Slots persist their state, shown in "Changed Runtime Values" if non-default (`true`). The original message is not passed through.

### Error Handling
- Invalid `slots` (non-integer, <2): Defaults to 2, red status (`invalid slots, using 2`).
- Missing `msg.context`: No output, red status (`missing context`).
- Missing `msg.payload`: No output, red status (`missing payload`).
- Invalid input index (e.g., `in3` for 2 slots): No output, red status (`invalid input index X`).
- Unknown `msg.context` (not `inX`): No output, yellow status (`unknown context`).
- Invalid message (e.g., `msg` undefined): No output, red status (`invalid message`).

### Status
- Green (dot): Configuration updates (e.g., `slots: 2`).
- Blue (dot): Outputs when state changes (e.g., `in: [true, false], out: false`).
- Blue (ring): Outputs when state unchanged (e.g., `in: [true, false], out: false`).
- Red (ring): Errors (e.g., `invalid slots, using 2`, `missing context`, `invalid message`).
- Yellow (ring): Warnings (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control)
</script>