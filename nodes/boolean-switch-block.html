<!-- UI Template Section -->
<script type="text/html" data-template-name="boolean-switch-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label><i class="fa fa-toggle-on"></i> Toggle</label>
        <button id="node-toggle-button" class="red-ui-button">Toggle</button>
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("boolean-switch-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["control"],
        outputLabels: ["slot value"],
        icon: "font-awesome/fa-toggle-on",
        paletteLabel: "boolean switch",
        label: function() {
            return this.name || "boolean switch";
        },
        oneditprepare: function() {
            const node = this;
            const id = this.id;

            // Initialize inputs
            $("#node-input-name").val(node.name || "");

            // Fetch runtime changes
            $.getJSON(`/boolean-switch-block-runtime/${id}`, function(data) {
                const runtime = data || {};
                const changes = [];
                if (runtime.state !== undefined && runtime.state !== false) {
                    changes.push(`state: ${runtime.state}`);
                }
                const displayText = changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None";
                $("#node-runtime-changes").text(displayText);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                $("#node-runtime-changes").text("Changed Values: Unknown (failed to fetch runtime)");
            });

            // Handle toggle button
            $("#node-toggle-button").click(function() {
                $.ajax({
                    url: `/boolean-switch-block/${id}/toggle`,
                    type: "POST",
                    success: function() {
                        // Refresh runtime changes
                        $.getJSON(`/boolean-switch-block-runtime/${id}`, function(data) {
                            const runtime = data || {};
                            const changes = [];
                            if (runtime.state !== undefined && runtime.state !== false) {
                                changes.push(`state: ${runtime.state}`);
                            }
                            const displayText = changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None";
                            $("#node-runtime-changes").text(displayText);
                        });
                    },
                    error: function() {
                        // Handle error silently
                    }
                });
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved
        },
        oneditvalidate: function() {
            return true; // Suppress all warnings
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="boolean-switch-block">
Toggles a boolean switch to gate output from two slots based on state.

### Inputs
: context (string) : Command (`"toggle"`, `"switch"`) or set slots (`"inTrue"`, `"inFalse"`).
: payload (any) : Value for slot when `msg.context` is `"inTrue"` or `"inFalse"`.

### Outputs
: payload (any) : Value of `inTrue` (switch `true`) or `inFalse` (switch `false`).

### Details
Maintains a boolean switch (`true` or `false`) and two slots (`inTrue`, `inFalse`) holding values. Outputs `inTrue` when switch is `true`, `inFalse` when `false`, triggered by state changes (`msg.context = "toggle"` or `"switch"`, editor toggle button) or active slot updates (`msg.context = "inTrue"` or `"inFalse"` when slot matches switch state). Non-active slot updates (e.g., `inFalse` when `true`) store values without output or status change. Switch state and slots are stored persistently in node context, surviving redeployments. Configurable via editor (`name`, toggle state). Runtime values (`name`, `state`, `inTrue`, `inFalse`) are shown in "Changed Runtime Values" if non-default (e.g., `state ≠ false`, `inTrue ≠ null`).

### Error Handling
- Missing `msg.context`: No output, red status (`missing context`).
- Missing `msg.payload` for slot update: No output, red status (`missing payload for X`).
- Unknown `msg.context` (not `"toggle"`, `"switch"`, `"inTrue"`, `"inFalse"`): No output, yellow status (`unknown context`).

### Status
- Green (dot): Configuration (e.g., `switch: inTrue` at startup).
- Blue (dot): Outputs (e.g., `switch: inTrue, out: 47`).
- Red (ring): Errors (e.g., `missing context`, `missing payload for inTrue`).
- Yellow (ring): Warnings (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control)
</script>