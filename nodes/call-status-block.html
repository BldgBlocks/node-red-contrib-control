<!-- UI Template Section: Defines the edit dialog -->
<script type="text/html" data-template-name="call-status-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-statusTimeout" title="Time to wait for status response (seconds, positive number)"><i class="fa fa-clock-o"></i> Status Timeout</label>
        <input type="number" id="node-input-statusTimeout" placeholder="30" min="0.01" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-clearDelay" title="Delay before clearing status and alarm after call ends (seconds, positive number)"><i class="fa fa-clock-o"></i> Clear Delay</label>
        <input type="number" id="node-input-clearDelay" placeholder="10" min="0.01" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-runLostStatus" title="Alarm if status is lost during call (boolean)"><i class="fa fa-exclamation-triangle"></i> Run Lost Status</label>
        <input type="checkbox" id="node-input-runLostStatus" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-noStatusOnRun" title="Alarm if no status received during call (boolean)"><i class="fa fa-exclamation-triangle"></i> No Status On Run</label>
        <input type="checkbox" id="node-input-noStatusOnRun" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-runLostStatusMessage" title="Message for run lost status alarm (string)"><i class="fa fa-comment"></i> Run Lost Message</label>
        <input type="text" id="node-input-runLostStatusMessage" placeholder="Status lost during run">
    </div>
    <div class="form-row">
        <label for="node-input-noStatusOnRunMessage" title="Message for no status on run alarm (string)"><i class="fa fa-comment"></i> No Status Message</label>
        <input type="text" id="node-input-noStatusOnRunMessage" placeholder="No status received during run">
    </div>
</script>

<!-- JavaScript Section: Registers the node and handles editor logic -->
<script type="text/javascript">
    RED.nodes.registerType("call-status-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            statusTimeout: { value: 30, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) > 0; } },
            clearDelay: { value: 10, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) > 0; } },
            runLostStatus: { value: false },
            noStatusOnRun: { value: true },
            runLostStatusMessage: { value: "Status lost during run" },
            noStatusOnRunMessage: { value: "No status received during run" }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output"],
        icon: "font-awesome/fa-phone",
        paletteLabel: "call status",
        label: function() {
            return this.name || "call status";
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="call-status-block">
Monitors call and status signals with alarm diagnostics.

### Inputs
- payload (boolean): Call activation/deactivation signal
- status (boolean): Status response from equipment (only processed when call is active)

### Outputs
- call (boolean): Current call state
- status (object): `{ call: boolean, status: boolean, alarm: boolean, alarmMessage: string, timeout: boolean, neverReceivedStatus: boolean }`

### Properties
- name (string): Display name in editor
- statusTimeout (number): Time to wait for status response (seconds, > 0)
- clearDelay (number): Delay before clearing status and alarm after call ends (seconds, > 0)
- runLostStatus (boolean): Alarm if status is lost during call
- noStatusOnRun (boolean): Alarm if no status received during call
- runLostStatusMessage (string): Message for status lost alarm
- noStatusOnRunMessage (string): Message for no status alarm

### Alarm Conditions
1. Status without call: Status=true when call=false (immediate alarm)
2. No status during call: No status received within timeout period (after statusTimeout)
3. Lost status during call: Status=false when call=true and status was previously received (immediate alarm)

### Behavior
- When call is activated: Expects status=true response
- Status is only processed when call is active
- Clears all state after clearDelay when call ends
- Timer acts as a blocking gate for status reception

### Status Indicators
- Green (ring): Configuration errors
- Blue (dot): Normal operation, no alarms
- Red (dot): Active alarm condition
- Yellow (ring): Invalid input
</script>
