<!-- UI Template Section: Defines the edit dialog -->
<script type="text/html" data-template-name="call-status-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-statusTimeout" title="Time to wait for status response (seconds, positive number)"><i class="fa fa-clock-o"></i> Status Timeout</label>
        <input type="number" id="node-input-statusTimeout" placeholder="30" min="0.01" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-clearDelay" title="Delay before clearing status and alarm after call ends (seconds, positive number)"><i class="fa fa-clock-o"></i> Clear Delay</label>
        <input type="number" id="node-input-clearDelay" placeholder="10" min="0.01" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-normalOff" title="Expected status when call is off (boolean)"><i class="fa fa-power-off"></i> Normal Off</label>
        <input type="checkbox" id="node-input-normalOff" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-normalOn" title="Expected status when call is on (boolean)"><i class="fa fa-power-off"></i> Normal On</label>
        <input type="checkbox" id="node-input-normalOn" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-runLostStatus" title="Alarm if status doesn't match normalOn during call (boolean)"><i class="fa fa-exclamation-triangle"></i> Run Lost Status</label>
        <input type="checkbox" id="node-input-runLostStatus" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-noStatusOnRun" title="Alarm if no status received during call (boolean)"><i class="fa fa-exclamation-triangle"></i> No Status On Run</label>
        <input type="checkbox" id="node-input-noStatusOnRun" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-runLostStatusMessage" title="Message for run lost status alarm (string)"><i class="fa fa-comment"></i> Run Lost Message</label>
        <input type="text" id="node-input-runLostStatusMessage" placeholder="Status lost during run">
    </div>
    <div class="form-row">
        <label for="node-input-noStatusOnRunMessage" title="Message for no status on run alarm (string)"><i class="fa fa-comment"></i> No Status Message</label>
        <input type="text" id="node-input-noStatusOnRunMessage" placeholder="No status received during run">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section: Registers the node and handles editor logic -->
<script type="text/javascript">
    RED.nodes.registerType("call-status-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            statusTimeout: { value: 30, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) > 0; } },
            clearDelay: { value: 10, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) > 0; } },
            normalOff: { value: false },
            normalOn: { value: true },
            runLostStatus: { value: false },
            noStatusOnRun: { value: true },
            runLostStatusMessage: { value: "Status lost during run" },
            noStatusOnRunMessage: { value: "No status received during run" }
        },
        inputs: 1,
        outputs: 2,
        inputLabels: ["input"],
        outputLabels: ["call", "diagnostics"],
        icon: "font-awesome/fa-phone",
        paletteLabel: "call status",
        label: function() {
            return this.name || "call status";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-name").val(node.name || "");
            $("#node-input-statusTimeout").val(node.statusTimeout || 30);
            $("#node-input-clearDelay").val(node.clearDelay || 10);
            $("#node-input-normalOff").prop("checked", node.normalOff === true);
            $("#node-input-normalOn").prop("checked", node.normalOn !== false);
            $("#node-input-runLostStatus").prop("checked", node.runLostStatus === true);
            $("#node-input-noStatusOnRun").prop("checked", node.noStatusOnRun !== false);
            $("#node-input-runLostStatusMessage").val(node.runLostStatusMessage || "Status lost during run");
            $("#node-input-noStatusOnRunMessage").val(node.noStatusOnRunMessage || "No status received during run");

            $.getJSON(`/call-status-block-runtime/${this.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.statusTimeout !== undefined && !isNaN(data.statusTimeout) && data.statusTimeout !== parseFloat(node.statusTimeout || 30)) {
                    changes.push(`statusTimeout: ${data.statusTimeout.toFixed(2)}`);
                }
                if (data.clearDelay !== undefined && !isNaN(data.clearDelay) && data.clearDelay !== parseFloat(node.clearDelay || 10)) {
                    changes.push(`clearDelay: ${data.clearDelay.toFixed(2)}`);
                }
                if (data.normalOff !== (node.normalOff === true)) changes.push(`normalOff: ${data.normalOff}`);
                if (data.normalOn !== (node.normalOn !== false)) changes.push(`normalOn: ${data.normalOn}`);
                if (data.runLostStatus !== (node.runLostStatus === true)) changes.push(`runLostStatus: ${data.runLostStatus}`);
                if (data.noStatusOnRun !== (node.noStatusOnRun !== false)) changes.push(`noStatusOnRun: ${data.noStatusOnRun}`);
                if (data.runLostStatusMessage !== (node.runLostStatusMessage || "Status lost during run")) {
                    changes.push(`runLostStatusMessage: ${data.runLostStatusMessage}`);
                }
                if (data.noStatusOnRunMessage !== (node.noStatusOnRunMessage || "No status received during run")) {
                    changes.push(`noStatusOnRunMessage: ${data.noStatusOnRunMessage}`);
                }
                if (data.call !== false) changes.push(`call: ${data.call}`);
                if (data.status !== false) changes.push(`status: ${data.status}`);
                if (data.alarm !== false) changes.push(`alarm: ${data.alarm}`);
                if (data.alarmMessage) changes.push(`alarmMessage: ${data.alarmMessage}`);
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved by Node-RED
        },
        oneditvalidate: function() {
            const statusTimeout = parseFloat($("#node-input-statusTimeout").val());
            const clearDelay = parseFloat($("#node-input-clearDelay").val());
            return !isNaN(statusTimeout) && statusTimeout > 0 && !isNaN(clearDelay) && clearDelay > 0;
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="call-status-block">
Issues calls to equipment with status and alarm diagnostics.

### Inputs
: context (string) : Configuration commands - (`"statusTimeout"`, `"clearDelay"`, `"normalOff"`, `"normalOn"`, `"runLostStatus"`, `"noStatusOnRun"`, `"runLostStatusMessage"`, `"noStatusOnRunMessage"`) or sets status (`"status"`). Unmatched values trigger error.
: payload (boolean | number | string) : Boolean for call, status, or boolean configs; number for timeouts; string for messages.

### Outputs
: call (boolean) : Current call state.
: diagnostics (object) : `{ call: boolean, status: boolean, alarm: boolean, alarmMessage: string, timeout: boolean }`.

### Properties
: name (string) : Display name in editor. Default: "" (shows "call status").
: statusTimeout (number) : Time to wait for status response (seconds, > 0). Default: 30.
: clearDelay (number) : Delay before clearing status and alarm after call ends (seconds, > 0). Default: 10.
: normalOff (boolean) : Expected status when call is off. Default: `false`.
: normalOn (boolean) : Expected status when call is on. Default: `true`.
: runLostStatus (boolean) : Alarm if status doesn't match `normalOn` during call. Default: `false`.
: noStatusOnRun (boolean) : Alarm if no status received during call. Default: `true`.
: runLostStatusMessage (string) : Message for run lost status alarm. Default: "Status lost during run".
: noStatusOnRunMessage (string) : Message for no status on run alarm. Default: "No status received during run".

### Details
Issues a call (`true`) to equipment via output 1 and expects a status response matching `normalOn` within `statusTimeout` seconds. 

Clears status and alarm after `clearDelay` seconds when call ends (`false`), checking against `normalOff`. 
Generates alarms for `runLostStatus` (status mismatch during call) or `noStatusOnRun` (no status within `statusTimeout`) with custom messages. 
Ignores status inputs without an active call.

### Status
- Green (dot): Configuration (e.g., `statusTimeout: 30.00`, `normalOn: true`).
- Blue (dot): Output, no alarm (e.g., `call: true, status: true, alarm: false`).
- Red (dot): Output with alarm (e.g., `run lost, alarm: true`).
- Red (ring): Errors (e.g., `invalid call`, `status ignored`).
- Yellow (ring): Unknown context (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>