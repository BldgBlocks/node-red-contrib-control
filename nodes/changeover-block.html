<script type="text/html" data-template-name="changeover-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-algorithm" title="Control algorithm type"><i class="fa fa-cog"></i> Algorithm</label>
        <select id="node-input-algorithm">
            <option value="single">Single Setpoint</option>
            <option value="split">Split Setpoints</option>
        </select>
    </div>
    <div class="form-row single-only">
        <label for="node-input-setpoint" title="Target temperature setpoint (number from num, msg, flow, or global)"><i class="fa fa-thermometer-half"></i> Setpoint</label>
        <input type="text" id="node-input-setpoint" class="node-input-typed" placeholder="70">
        <input type="hidden" id="node-input-setpointType">
    </div>
    <div class="form-row single-only">
        <label for="node-input-deadband" title="Temperature range for no action (positive number)"><i class="fa fa-arrows-v"></i> Deadband</label>
        <input type="text" id="node-input-deadband" placeholder="2">
    </div>
    <div class="form-row split-only" style="display: none;">
        <label for="node-input-heatingSetpoint" title="Heating setpoint for split algorithm (number from num, msg, flow, or global)"><i class="fa fa-thermometer-empty"></i> Heating Setpoint</label>
        <input type="text" id="node-input-heatingSetpoint" class="node-input-typed" placeholder="68">
        <input type="hidden" id="node-input-heatingSetpointType">
    </div>
    <div class="form-row split-only" style="display: none;">
        <label for="node-input-coolingSetpoint" title="Cooling setpoint for split algorithm (number from num, msg, flow, or global)"><i class="fa fa-thermometer-full"></i> Cooling Setpoint</label>
        <input type="text" id="node-input-coolingSetpoint" class="node-input-typed" placeholder="74">
        <input type="hidden" id="node-input-coolingSetpointType">
    </div>
    <div class="form-row">
        <label for="node-input-anticipator" title="Temperature offset for proactive mode switching (non-negative number)"><i class="fa fa-tachometer"></i> Anticipator</label>
        <input type="text" id="node-input-anticipator" placeholder="0.5">
    </div>
    <div class="form-row">
        <label for="node-input-swapTime" title="Minimum time before mode change (seconds, non-negative number from num, msg, flow, or global)"><i class="fa fa-clock-o"></i> Swap Time</label>
        <input type="text" id="node-input-swapTime" class="node-input-typed" placeholder="300">
        <input type="hidden" id="node-input-swapTimeType">
    </div>
    <div class="form-row">
        <label for="node-input-minTempSetpoint" title="Minimum allowable setpoint"><i class="fa fa-thermometer-empty"></i> Min Setpoint</label>
        <input type="text" id="node-input-minTempSetpoint" placeholder="55">
    </div>
    <div class="form-row">
        <label for="node-input-maxTempSetpoint" title="Maximum allowable setpoint"><i class="fa fa-thermometer-full"></i> Max Setpoint</label>
        <input type="text" id="node-input-maxTempSetpoint" placeholder="90">
    </div>
    <div class="form-row">
        <label for="node-input-minCycleTime" title="Minimum cycle time (seconds, non-negative number)"><i class="fa fa-refresh"></i> Min Cycle Time</label>
        <input type="text" id="node-input-minCycleTime" placeholder="60">
    </div>
    <div class="form-row">
        <label for="node-input-initWindow" title="Initialization window to collect inputs before mode selection (seconds, non-negative number)"><i class="fa fa-hourglass-start"></i> Init Window</label>
        <input type="text" id="node-input-initWindow" placeholder="10">
    </div>
    <div class="form-row">
        <label for="node-input-operationMode" title="Operation mode"><i class="fa fa-cogs"></i> Operation Mode</label>
        <select id="node-input-operationMode">
            <option value="auto">Auto</option>
            <option value="heat">Heat</option>
            <option value="cool">Cool</option>
        </select>
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("changeover-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            algorithm: { value: "single" },
            setpoint: { value: "70" },
            setpointType: { value: "num" },
            deadband: { value: "2" },
            heatingSetpoint: { value: "68" },
            heatingSetpointType: { value: "num" },
            coolingSetpoint: { value: "74" },
            coolingSetpointType: { value: "num" },
            anticipator: { value: "0.5" },
            swapTime: { value: "300" },
            swapTimeType: { value: "num" },
            minTempSetpoint: { value: "55" },
            maxTempSetpoint: { value: "90" },
            minCycleTime: { value: "60" },
            initWindow: { value: "10" },
            operationMode: { value: "auto" }
        },
        inputs: 1,
        outputs: 2,
        inputLabels: ["temperature"],
        outputLabels: ["isHeating", "status"],
        icon: "font-awesome/fa-retweet",
        paletteLabel: "changeover",
        label: function() {
            return this.name || "changeover";
        },
        oneditprepare: function() {
            const node = this;
            const $algorithm = $("#node-input-algorithm");
            const $singleFields = $(".single-only");
            const $splitFields = $(".split-only");

            // Initialize typed inputs
            const setpointInput = $("#node-input-setpoint").typedInput({
                default: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-setpointType"
            });
            setpointInput.typedInput("type", node.setpointType || "num");
            setpointInput.typedInput("value", node.setpoint || "70");

            const heatingSetpointInput = $("#node-input-heatingSetpoint").typedInput({
                default: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-heatingSetpointType"
            });
            heatingSetpointInput.typedInput("type", node.heatingSetpointType || "num");
            heatingSetpointInput.typedInput("value", node.heatingSetpoint || "68");

            const coolingSetpointInput = $("#node-input-coolingSetpoint").typedInput({
                default: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-coolingSetpointType"
            });
            coolingSetpointInput.typedInput("type", node.coolingSetpointType || "num");
            coolingSetpointInput.typedInput("value", node.coolingSetpoint || "74");

            const swapTimeInput = $("#node-input-swapTime").typedInput({
                default: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-swapTimeType"
            });
            swapTimeInput.typedInput("type", node.swapTimeType || "num");
            swapTimeInput.typedInput("value", node.swapTime || "300");

            // Toggle fields based on algorithm
            function toggleFields() {
                if ($algorithm.val() === "single") {
                    $singleFields.show();
                    $splitFields.hide();
                } else {
                    $singleFields.hide();
                    $splitFields.show();
                }
            }

            $algorithm.on("change", toggleFields);
            toggleFields();

            // Fetch runtime changes
            $.getJSON(`/changeover-block-runtime/${node.id}`, function(data) {
                const runtime = data || {};
                const changes = [];
                if (runtime.name) changes.push(`name: ${runtime.name}`);
                if (runtime.algorithm !== "single") changes.push(`algorithm: ${runtime.algorithm}`);
                if (runtime.algorithm === "single") {
                    if (runtime.setpoint !== undefined && runtime.setpoint !== Number(node.setpoint)) {
                        const effectiveHeating = runtime.setpoint - (runtime.deadband || node.deadband) / 2;
                        const effectiveCooling = runtime.setpoint + (runtime.deadband || node.deadband) / 2;
                        changes.push(`setpoint: ${parseFloat(runtime.setpoint).toFixed(1)}`);
                        changes.push(`effectiveHeating: ${effectiveHeating.toFixed(1)}`);
                        changes.push(`effectiveCooling: ${effectiveCooling.toFixed(1)}`);
                    }
                    if (runtime.deadband !== undefined && runtime.deadband !== Number(node.deadband)) {
                        changes.push(`deadband: ${runtime.deadband.toFixed(1)}`);
                    }
                } else {
                    if (runtime.heatingSetpoint !== undefined && runtime.heatingSetpoint !== Number(node.heatingSetpoint)) {
                        changes.push(`heatingSetpoint: ${parseFloat(runtime.heatingSetpoint).toFixed(1)}`);
                    }
                    if (runtime.coolingSetpoint !== undefined && runtime.coolingSetpoint !== Number(node.coolingSetpoint)) {
                        changes.push(`coolingSetpoint: ${parseFloat(runtime.coolingSetpoint).toFixed(1)}`);
                    }
                }
                if (runtime.anticipator !== 0.5) changes.push(`anticipator: ${runtime.anticipator.toFixed(1)}`);
                if (runtime.swapTime !== 300) changes.push(`swapTime: ${runtime.swapTime}`);
                if (runtime.minTempSetpoint !== 55) changes.push(`minTempSetpoint: ${runtime.minTempSetpoint.toFixed(1)}`);
                if (runtime.maxTempSetpoint !== 90) changes.push(`maxTempSetpoint: ${runtime.maxTempSetpoint.toFixed(1)}`);
                if (runtime.minCycleTime !== 60) changes.push(`minCycleTime: ${runtime.minCycleTime}`);
                if (runtime.initWindow !== 10) changes.push(`initWindow: ${runtime.initWindow}`);
                if (runtime.operationMode !== "auto") changes.push(`operationMode: ${runtime.operationMode}`);
                if (runtime.currentMode !== (runtime.operationMode === "cool" ? "cooling" : "heating")) changes.push(`currentMode: ${runtime.currentMode}`);
                if (runtime.lastTemperature !== null) changes.push(`lastTemperature: ${runtime.lastTemperature.toFixed(1)}`);

                const displayText = changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None";
                $("#node-runtime-changes").text(displayText);
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown (failed to fetch runtime)");
            });

            // Disable typedInput validation but allow global paths
            $(".node-input-typed").each(function() {
                $(this).typedInput("validate", function(value, type) {
                    if (type === "global" && value) {
                        return !!value;
                    }
                    return true;
                });
            });

            // Validate non-typed inputs
            $("#node-input-deadband").on("input", function() {
                const val = parseFloat($(this).val());
                if (isNaN(val) || val <= 0) $(this).addClass("input-error");
                else $(this).removeClass("input-error");
            });

            $("#node-input-anticipator").on("input", function() {
                const val = parseFloat($(this).val());
                if (isNaN(val) || val < 0) $(this).addClass("input-error");
                else $(this).removeClass("input-error");
            });

            $("#node-input-minTempSetpoint").on("input", function() {
                const val = parseFloat($(this).val());
                const max = parseFloat($("#node-input-maxTempSetpoint").val());
                if (isNaN(val) || val >= max) $(this).addClass("input-error");
                else $(this).removeClass("input-error");
            });

            $("#node-input-maxTempSetpoint").on("input", function() {
                const val = parseFloat($(this).val());
                const min = parseFloat($("#node-input-minTempSetpoint").val());
                if (isNaN(val) || val <= min) $(this).addClass("input-error");
                else $(this).removeClass("input-error");
            });

            $("#node-input-minCycleTime").on("input", function() {
                const val = parseFloat($(this).val());
                if (isNaN(val) || val < 0) $(this).addClass("input-error");
                else $(this).removeClass("input-error");
            });

            $("#node-input-initWindow").on("input", function() {
                const val = parseFloat($(this).val());
                if (isNaN(val) || val < 0) $(this).addClass("input-error");
                else $(this).removeClass("input-error");
            });
        },
        oneditsave: function() {
            // Save typed input types and values
            $("#node-input-setpointType").val($("#node-input-setpoint").typedInput("type"));
            $("#node-input-setpoint").val($("#node-input-setpoint").typedInput("value"));
            $("#node-input-heatingSetpointType").val($("#node-input-heatingSetpoint").typedInput("type"));
            $("#node-input-heatingSetpoint").val($("#node-input-heatingSetpoint").typedInput("value"));
            $("#node-input-coolingSetpointType").val($("#node-input-coolingSetpoint").typedInput("type"));
            $("#node-input-coolingSetpoint").val($("#node-input-coolingSetpoint").typedInput("value"));
            $("#node-input-swapTimeType").val($("#node-input-swapTime").typedInput("type"));
            $("#node-input-swapTime").val($("#node-input-swapTime").typedInput("value"));
        }
    });
</script>

<script type="text/markdown" data-help-name="changeover-block">
Manages HVAC mode switching between heating and cooling based on temperature inputs and setpoint configurations.

### Inputs
: context (string) : Configures node settings (`"operationMode"`, `"algorithm"`, `"setpoint"`, `"deadband"`, `"heatingSetpoint"`, `"coolingSetpoint"`, `"anticipator"`, `"swapTime"`, `"minTempSetpoint"`, `"maxTempSetpoint"`, `"minCycleTime"`, `"initWindow"`). Unknown values trigger a warning.
: payload (number | string) : Temperature for mode evaluation; configuration value with `msg.context`.

### Outputs
: isHeating (boolean) : `true` for heating, `false` for cooling, with `msg.context = "isHeating"`.
: status (object) : `{ mode, isHeating, heatingSetpoint, coolingSetpoint, temperature }`.

### Algorithms
The node supports two algorithms for determining HVAC mode:

- **Single Setpoint**:
  - Uses a single `setpoint` and `deadband` to define a temperature range.
  - **Heating** is triggered if the input temperature is below `setpoint - deadband/2 - anticipator`.
  - **Cooling** is triggered if the temperature exceeds `setpoint + deadband/2 + anticipator`.
  - Example: With `setpoint=70`, `deadband=2`, `anticipator=0.5`, heating starts below `70 - 2/2 - 0.5 = 68.5`, and cooling starts above `70 + 2/2 + 0.5 = 71.5`.
  - The `anticipator` proactively adjusts thresholds to prevent overshooting.

- **Split Setpoint**:
  - Uses separate `heatingSetpoint` and `coolingSetpoint` for explicit control.
  - **Heating** is triggered if the temperature is below `heatingSetpoint - anticipator`.
  - **Cooling** is triggered if the temperature exceeds `coolingSetpoint + anticipator`.
  - Example: With `heatingSetpoint=68`, `coolingSetpoint=74`, `anticipator=0.5`, heating starts below `68 - 0.5 = 67.5`, and cooling starts above `74 + 0.5 = 74.5`.
  - Ensures `coolingSetpoint >= heatingSetpoint` to avoid overlap.

### Details
Controls HVAC mode (heating or cooling) based on `msg.payload` temperature compared to setpoints. The node caches the last temperature to make an immediate mode decision after the `initWindow` period, avoiding delays.

- In **auto** mode, the node switches modes based on the algorithm thresholds, requiring the condition to persist for `swapTime` seconds. A countdown is shown (e.g., `pending: cooling in 120s`).
- In **heat** or **cool** mode, the node locks to heating or cooling, respectively, ignoring temperature inputs.
- The `anticipator` adjusts thresholds to proactively switch modes, reducing overshooting.
- Configuration options can be set via the editor or `msg.context` (e.g., `{ context: "setpoint", payload: 72 }`).
- Runtime changes are displayed in "Changed Runtime Values" if different from defaults.
- State (`currentMode`, `lastTemperature`) persists across redeployments.

### Error Handling
- Missing `msg`: No output, status: `red ring, invalid message`.
- Missing `msg.payload` for temperature: No output, status: `red ring, missing temperature`.
- Missing `msg.payload` for context: No output, status: `red ring, missing payload for X`.
- Invalid temperature (non-numeric): No output, status: `red ring, invalid temperature`.
- Invalid `operationMode` (not `auto`, `heat`, `cool`): No output, status: `red ring, invalid operationMode`.
- Invalid `algorithm` (not `single`, `split`): No output, status: `red ring, invalid algorithm`.
- Invalid numeric context (e.g., non-numeric, out-of-range): No output, status: `red ring, invalid X`.
- Wrong context for algorithm (e.g., `setpoint` in split): No output, status: `red ring, X not used in Y algorithm`.
- Unknown `msg.context`: No output, status: `yellow ring, unknown context`.

### Status
- Green (dot): Configuration updated (e.g., `in: setpoint=70.0, out: heating`).
- Blue (dot): Mode changed (e.g., `in: temp=65.0, out: heating`).
- Blue (ring): No mode change (e.g., `in: temp=70.0, out: cooling, pending: heating in 120s`).
- Red (ring): Errors (e.g., `missing temperature`, `invalid setpoint`).
- Yellow (ring): Initializing (e.g., `initializing, out: heating`) or warning (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control)
</script>