<!-- UI Template Section: Defines the edit dialog for the Compare Block node -->
<script type="text/html" data-template-name="compare-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-setpoint" title="Default setpoint value for comparison (number)"><i class="fa fa-crosshairs"></i> Setpoint</label>
        <input type="number" id="node-input-setpoint" placeholder="50" step="any">
    </div>
</script>

<!-- JavaScript Section: Registers the node and handles editor logic -->
<script type="text/javascript">
    RED.nodes.registerType("compare-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "compare" },
            setpoint: { value: 50, required: true, validate: function(v) { return !isNaN(parseFloat(v)); } }
        },
        inputs: 1,
        outputs: 3,
        outputLabels: ["greater than", "equal to", "less than"],
        inputLabels: ["input"],
        icon: "font-awesome/fa-wrench",
        paletteLabel: "compare",
        label: function() {
            return this.name || "compare";
        },
        oneditprepare: function() {
            const id = this.id;
            // Initialize with pending client-side values
            $("#node-input-name").val(this.name || "compare");
            $("#node-input-setpoint").val(this.setpoint || 50);

            // Fetch server data only for deployed nodes
            $.getJSON(`/compare-block/${id}?t=${Date.now()}`, function(data) {
                // Only update if node is deployed and data differs
                if (data && (data.name !== this.name || data.setpoint !== this.setpoint)) {
                    $("#node-input-name").val(data.name || this.name || "compare");
                    $("#node-input-setpoint").val(data.setpoint || this.setpoint || 50);
                }
            }.bind(this)).fail(function() {
                // No server data; rely on this properties (already set)
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved by Node-RED
        }
    });
</script>

<!-- Help Section: Provides documentation for the Compare Block node -->
<script type="text/markdown" data-help-name="compare-block">
Compares a number input to a setpoint, outputting three boolean signals.

### Inputs
- **context** <span class="property-type">string</span>
  Sets configuration ("setpoint" to update setpoint).
- **payload** <span class="property-type">number</span>
  Input number to compare, or setpoint value for config.

### Outputs
1. **greater than** <span class="property-type">boolean</span>
   True if input > setpoint, else false.
2. **equal to** <span class="property-type">boolean</span>
   True if input = setpoint, else false.
3. **less than** <span class="property-type">boolean</span>
   True if input < setpoint, else false.

### Details
The Compare Block compares `msg.payload` (a number) to a setpoint (default: 50). It outputs three messages to separate ports indicating if the input is greater than, equal to, or less than the setpoint.

The node name and default setpoint are configurable in the editor. The setpoint can be updated via `msg.context = "setpoint"` with `msg.payload` as a number. Editor changes require redeployment; message-based changes apply immediately and are reflected in the editor.

The node outputs new messages for every valid input.

### Examples
- **Compare Input**: Input `{ payload: 55 }` with setpoint 50, output: `[ { payload: true }, { payload: false }, { payload: false } ]`.
- **Setpoint Update**: Input `{ context: "setpoint", payload: 60 }`, no output, updates setpoint to 60.
- **Equal Input**: Input `{ payload: 60 }` with setpoint 60, output: `[ { payload: false }, { payload: true }, { payload: false } ]`.

### Error Handling
- Missing `msg.payload`: Shows "missing input" or "missing payload" (red), no output.
- Invalid input or setpoint (non-numeric, NaN): Shows "invalid input" or "invalid setpoint" (red), no output.
- Unknown `msg.context`: Shows "unknown context" (yellow), no output.

Status shows green for configuration (e.g., `setpoint: 60`), blue for output (e.g., `in: 55.00, sp: 50, out: [true, false, false]`), red for errors, yellow for unknown context.

### References
- [Node-RED Documentation](https://nodered.org/docs/) - official Node-RED documentation
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control) - source code and additional help
</script>