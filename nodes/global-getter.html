<script type="text/html" data-template-name="global-getter">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-targetNode"><i class="fa fa-crosshairs"></i> Source</label>
        <div style="display: inline-flex; width: 70%;">
            <input type="text" id="node-input-targetNode" style="flex-grow: 1;">
            <button id="node-config-find-source" class="editor-button" style="margin-left: 5px; width: 40px;" title="Find Source Node">
                <i class="fa fa-search"></i>
            </button>
        </div>
    </div>
    
    <div class="form-row">
        <label for="node-input-outputProperty"><i class="fa fa-arrow-right"></i> Output</label>
        <input type="text" id="node-input-outputProperty" placeholder="payload" style="width:70%;">
    </div>

    <div class="form-tips">
        Targeting by Node ID allows the source path to change without breaking this link.
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('global-getter', {
        category: 'control',
        color: '#301934',
        defaults: {
            name: { value: "" },
            targetNode: { value: "", required: true },
            outputProperty: { value: "payload", required: true }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-align-left",
        label: function() {
            if (this.targetNode) {
                const target = RED.nodes.node(this.targetNode);
                if (target) {
                    let lbl = target.path || target.name;
                    if(lbl && lbl.includes(":")) {
                        lbl = lbl.split(":")[1];
                    }
                    return "Get: " + lbl;
                }
            }
            return this.name || "global get";
        },
        paletteLabel: "global get",
        oneditprepare: function() {
            const node = this;
            
            // 1. Populate Dropdown
            let candidateNodes = [];
            RED.nodes.eachNode(function(n) {
                if (n.type === 'global-setter') {
                    let displayPath = n.path || "No Path";
                    // Clean label visualization
                    if (displayPath.includes(":") && displayPath.startsWith("#")) {
                         displayPath = displayPath.split(":")[1]; 
                    }

                    candidateNodes.push({
                        value: n.id,
                        label: displayPath + (n.name ? ` (${n.name})` : "")
                    });
                }
            });

            candidateNodes.sort((a, b) => a.label.localeCompare(b.label));

            $("#node-input-targetNode").typedInput({
                types: [{
                    value: "target",
                    options: candidateNodes
                }]
            });

            // 2. Output Property Selector
            $("#node-input-outputProperty").typedInput({
                types: ['msg']
            });

            // 3. Find Button Logic
            $("#node-config-find-source").on("click", function() {
                const selectedId = $("#node-input-targetNode").val();
                if (selectedId) {
                    // Node-RED API to jump to a node
                    RED.view.reveal(selectedId);
                } else {
                    RED.notify("Please select a source node first.", "warning");
                }
            });
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="global-getter">
Manage a global variable in a repeatable way.

### Inputs 

### Outputs
: payload (any) : The global variable value
: topic (string) : The variable name/path used to store the value.
: globalMetadata (object) : Metadata about the global variable (store, path).

### Details
Global variables are meant to be retrieved in other places, this necessarily means managing the same string in multiple places. 

This node allows you to get a global variable while supporting rename and deletion.

It links to a `global-setter` node by Node ID, so if that node's path is changed, this node will still work.

### Status
- Green (dot): Configuration update
- Blue (dot): State changed
- Blue (ring): State unchanged
- Red (ring): Error
- Yellow (ring): Warning

### References
- [Node-RED Documentation](https://nodered.org/docs/)  
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>