<script type="text/html" data-template-name="global-setter">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-path"><i class="fa fa-sitemap"></i> Global Path</label>
        <input type="text" id="node-input-path" style="width: 70%;" placeholder="furnace/outputs/heat">
    </div>
    <div class="form-row">
        <label for="node-input-property"><i class="fa fa-ellipsis-h"></i> Input</label>
        <input type="text" id="node-input-property" style="width:70%;">
    </div>
    <div class="form-row">
        <label for="node-input-writePriority" title="Priority is evaluated for final value when using global-setter/getter nodes."><i class="fa fa-sort-numeric-asc"></i> Priority</label>
        <input type="text" id="node-input-writePriority" placeholder="single">
        <input type="hidden" id="node-input-writePriorityType">
    </div>
    
    <hr>
    
    <div class="form-row">
        <label for="node-input-defaultValue" title="Static default value to ensure one exists. You may write to default through message configuration."><i class="fa fa-undo"></i> Default</label>
        <input type="text" id="node-input-defaultValue" placeholder="e.g. 0 or false">
    </div>

    <div class="form-tips">
        <b>Note:</b> This node writes to the selected <b>Priority Level</b>. The actual Global Variable value will be the highest active priority.
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('global-setter', {
        category: 'control',
        color: '#E2D96E',
        defaults: {
            name: { value: "" },
            path: { value: "", required: true },
            property: { value: "payload", required: true },
            defaultValue: { value: "", required: true },
            writePriority: { value: "16", required: true },
            writePriorityType: { value: "dropdown" }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-align-right",
        label: function() {
            let lbl = this.path;
            if (lbl && lbl.startsWith("#") && lbl.includes(":")) {
                lbl = lbl.substring(lbl.indexOf(":") + 1);
            }
            return this.name || "set: " + lbl || "global set";
        },
        paletteLabel: "global set",
        oneditprepare: function() {
            // These are read as strings not evaluated typed-inputs.
            $("#node-input-path").typedInput({ types: ['global'] });
            // getMessageProperty handles msg access on the incoming message at the specified path.
            $("#node-input-property").typedInput({ types: ['msg'] });
            // Default for the default value, meaning it should only be manually set. You can still pass default values through messages.
            $("#node-input-defaultValue").typedInput({ types: ['str','num','bool'] });

            $("#node-input-writePriority").typedInput({
                default: "dropdown",
                types: [{
                    value: "dropdown",
                    options: [
                        { value: "1", label: "1 (Life Safety)"},
                        { value: "2", label: "2"},
                        { value: "3", label: "3"},
                        { value: "4", label: "4"},
                        { value: "5", label: "5"},
                        { value: "6", label: "6"},
                        { value: "7", label: "7"},
                        { value: "8", label: "8 (Manual Operator)"},
                        { value: "9", label: "9"},
                        { value: "10", label: "10"},
                        { value: "11", label: "11"},
                        { value: "12", label: "12"},
                        { value: "13", label: "13"},
                        { value: "14", label: "14"},
                        { value: "15", label: "15"},
                        { value: "16", label: "16 (Schedule/Logic)"},
                        { value: "default", label: "default (fallback)"},
                    ]
                }, "msg", "flow"],
                typeField: "#node-input-writePriorityType"
            }).typedInput("type", node.writePriorityType).typedInput("value", node.writePriority);
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="global-setter">
Manage a global variable in a repeatable way.

### Inputs 
: payload (any) : Input payload is passed through unchanged.
: property (string) : The input property where the value is taken from.
: units (string) : The units associated with the value, if any. Also supports nested units at `msg.<inputProperty>.units`.

### Outputs
: payload (any) : Original payload.

### Details
Global variables are meant to be retrieved in other places, this necessarily means managing the same string in multiple places. 

This node allows you to set a global variable in one place, and retrieve it elsewhere using the `global-getter` node while supporting rename and deletion.

When this node is deleted or the flow is redeployed, it will automatically remove (prune) the variable from the selected Context Store.

### Status
- Green (dot): Configuration update
- Blue (dot): State changed
- Blue (ring): State unchanged
- Red (ring): Error
- Yellow (ring): Warning

### References
- [Node-RED Documentation](https://nodered.org/docs/)  
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>
