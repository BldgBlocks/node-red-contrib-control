<script type="text/html" data-template-name="history-buffer">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Trend History">
    </div>
    <div class="form-row">
        <label for="node-input-bufferHours" title="How many hours of history to retain (default 3)"><i class="fa fa-clock-o"></i> Buffer Hours</label>
        <input type="number" id="node-input-bufferHours" placeholder="3" min="0.01" max="24" step="0.01">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("history-buffer", {
        category: "bldgblocks history",
        color: "#b9f2ff",
        defaults: {
            name: { value: "" },
            bufferHours: {
                value: 3,
                required: true,
                validate: function(v) {
                    const val = parseFloat(v);
                    return !isNaN(val) && val >= 0.01 && val <= 24;
                }
            }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["data"],
        outputLabels: ["chart"],
        icon: "font-awesome/fa-history",
        paletteLabel: "history buffer",
        label: function() {
            return this.name ? `${this.name} (${this.bufferHours}h)` : `history buffer (${this.bufferHours}h)`;
        }
    });
</script>

<script type="text/markdown" data-help-name="history-buffer">
Persistent trend history for FlowFuse Dashboard 2.0 `ui-chart` nodes.

Stores time-series data as hourly files on disk, surviving Node-RED restarts without blocking startup or using global context.

### Inputs
: topic (string) : Series identifier (e.g., "Return Temp").
: payload (number) : Data value for this series.
: ts (number) : Timestamp in milliseconds (optional, auto-filled).

### Outputs
: topic (string) : Series identifier.
: payload (number|array) : Single value (append) or array of points (replace).
: ts (number) : Timestamp in milliseconds.
: action (string) : `"replace"` on startup, `"append"` for live data.

### ui-chart Configuration (IMPORTANT)

The `ui-chart` node **must** be configured to read data from the correct keys.

In the chart's **Properties** section, set:

| Property | Type | Value |
|----------|------|-------|
| **Series** | `key` | `topic` |
| **X** | `key` | `ts` |
| **Y** | `key` | `payload` |

**Critical:** The type must be `key` (not `msg`). This tells the chart to look *inside* each array element for these fields.

Also set:
- **X-Axis Type**: `Timescale`
- **X-Axis Limit**: Match your buffer hours or leave default

### Storage

Data is stored as Line-Delimited JSON in `~/.node-red/.bldgblocks/trends/`:
- `buffer_<nodeid>.json` : Active buffer, committed every 30 seconds
- `trend_<timestamp>_<nodeid>.json` : Hourly rotation files

On startup:
1. Waits 5 seconds for Node-RED to stabilize
2. Loads all files within retention window
3. Sends historical data with `action: "replace"`
4. Begins accepting live data

Supports 0.01 to 24 hours retention. Old files pruned automatically.

### Status
- **Green** : Ready
- **Blue** : Active, receiving data
- **Yellow** : Warning (file issue)
- **Red** : Error

### References
- [ui-chart Documentation](https://dashboard.flowfuse.com/nodes/widgets/ui-chart.html)
- [GitHub](https://github.com/BldgBlocks/node-red-contrib-control.git)
</script>
