<script type="text/html" data-template-name="history-buffer">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Trend History">
    </div>
    <div class="form-row">
        <label for="node-input-bufferHours" title="How many hours of history to retain (default 3)"><i class="fa fa-clock-o"></i> Buffer Hours</label>
        <input type="number" id="node-input-bufferHours" placeholder="3" min="0.01" max="24" step="0.01">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("history-buffer", {
        category: "bldgblocks history",
        color: "#b9f2ff",
        defaults: {
            name: { value: "" },
            bufferHours: {
                value: 3,
                required: true,
                validate: function(v) {
                    const val = parseFloat(v);
                    return !isNaN(val) && val >= 0.01 && val <= 24;
                }
            }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["data"],
        outputLabels: ["chart"],
        icon: "font-awesome/fa-history",
        paletteLabel: "history buffer",
        label: function() {
            return this.name ? `${this.name} (${this.bufferHours}h)` : `history buffer (${this.bufferHours}h)`;
        }
    });
</script>

<script type="text/markdown" data-help-name="history-buffer">
Persistent trend history for FlowFuse Dashboard 2.0 ui-chart nodes, stored as hourly files instead of context.

No dependencies, settings.js, or context config required. Does not block Node-RED startup. Does not hammer SD storage. Does not spike CPU.

### Inputs
: topic (string) : Series identifier (e.g., "Return Temp", "Supply Temp").
: payload (number) : Data value for this series.
: ts (number) : Unix timestamp (optional, auto-filled if missing).

### Outputs
: topic (string) : Series identifier passed through.
: payload (number) : Data value.
: ts (number) : Timestamp.
: action (string) : "replace" (first historical point on startup) or "append" (subsequent points).

### Details
Maintains a rolling buffer of time-series data in hourly chunks on disk, persisting across Node-RED restarts without blocking startup or using global context.

Data is stored as Line-Delimited JSON (JSONL) in `~/.node-red/.bldgblocks/trends/`:
- `buffer_current.json` : Active file, appended every 30 seconds
- `trend_<timestamp>.json` : Finalized hourly chunks

On startup (5-second delay):
- Loads all historical files within buffer age
- Sends each point with action="replace" for first, "append" for rest
- Begins accepting live data

Supports 0.01 to 24 hours retention. Old files are automatically pruned every 60 seconds.

### Memory
- Live buffer: ~20-40 KB (accumulates between commits)
- Historical chunks: Loaded briefly during startup, then discarded
- Total active memory: <100 KB

### Status
- Green (dot) : Ready or configuration updated
- Blue (dot) : History loaded, receiving live data
- Red (ring) : Error (missing topic/payload, file write failure)
- Yellow (ring) : Warning (invalid file, prune failure)

### References
- [FlowFuse Dashboard 2.0](https://flowfuse.com/docs/user/dashboard/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-control.git)
</script>
