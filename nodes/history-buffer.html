<script type="text/html" data-template-name="history-buffer">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-bufferHours"><i class="fa fa-clock-o"></i> Buffer Duration</label>
        <input type="number" id="node-input-bufferHours" placeholder="3" min="0.01" max="24" step="0.01">
        <span style="margin-left: 10px; color: #666;">hours</span>
    </div>
    <div class="form-row">
        <label for="node-input-commitIntervalMin"><i class="fa fa-save"></i> Commit Interval</label>
        <input type="number" id="node-input-commitIntervalMin" placeholder="10" min="1" max="120" step="1">
        <span style="margin-left: 10px; color: #666;">minutes</span>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("history-buffer", {
        category: "bldgblocks history",
        color: "#b9f2ff",
        defaults: {
            name: { value: "" },
            bufferHours: {
                value: 3,
                required: true,
                validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0.01 && parseFloat(v) <= 24; }
            },
            commitIntervalMin: {
                value: 10,
                required: true,
                validate: function(v) { return !isNaN(parseInt(v)) && parseInt(v) >= 1 && parseInt(v) <= 120; }
            }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["data"],
        outputLabels: ["buffered"],
        icon: "font-awesome/fa-history",
        paletteLabel: "history buffer",
        label: function() {
            return this.name || "history buffer";
        }
    });
</script>

<script type="text/markdown" data-help-name="history-buffer">
Maintains a rolling buffer of time-series data with periodic persistence across Node-RED restarts.

### Inputs
: topic (string) : Series name or identifier (e.g., "Return Temperature", "HP Stage 1").
: payload (number) : The data point value (temperature, state, etc.).
: ts (number, optional) : Timestamp in milliseconds. Auto-added if missing.

### Outputs
: topic (string) : Same series name from input.
: payload (number) : Same data value from input.
: ts (number) : Timestamp of the data point.
: status (object) : Status object with action, buffer size, and timestamp.

### Details
Buffers incoming data points in memory while periodically saving to persistent node context. Restores all historical data on Node-RED restart or deploy.

On startup, all previously stored points are replayed to restore chart visualization. Subsequent data is appended to the buffer with `msg.status.action: "append"`. Every N minutes (commit interval), data older than the buffer duration is pruned, and remaining points are saved to context.

Configuration options control how long to keep data (buffer duration, default 3 hours) and how often to persist (commit interval, default 10 minutes). Adjust based on desired history depth and storage frequency.

The node validates that incoming messages have `msg.topic` and `msg.payload`. Timestamps are required for accurate time-series charting; missing timestamps are auto-added using current time.

### Status
: green (dot) : Configuration update or normal operation
: blue (dot) : Data received and buffered
: yellow (ring) : Warning (missing topic or payload)
: red (ring) : Error (storage or persistence failure)

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>
