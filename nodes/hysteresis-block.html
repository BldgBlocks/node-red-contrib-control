<!-- UI Template Section: Defines the edit dialog -->
<script type="text/html" data-template-name="hysteresis-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-upperLimit" title="Upper threshold for switching to above state (number)"><i class="fa fa-arrow-up"></i> Upper Limit</label>
        <input type="number" id="node-input-upperLimit" placeholder="50" min="0" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-lowerLimit" title="Lower threshold for switching to below state (number)"><i class="fa fa-arrow-down"></i> Lower Limit</label>
        <input type="number" id="node-input-lowerLimit" placeholder="30" min="0" step="any">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section: Registers the node and handles editor logic -->
<script type="text/javascript">
    RED.nodes.registerType("hysteresis-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            upperLimit: { value: 50, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0; } },
            lowerLimit: { value: 30, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0; } }
        },
        inputs: 1,
        outputs: 3,
        inputLabels: ["input"],
        outputLabels: ["above", "within", "below"],
        icon: "font-awesome/fa-toggle-on",
        paletteLabel: "hysteresis",
        label: function() {
            return this.name || "hysteresis";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-name").val(node.name || "");
            $("#node-input-upperLimit").val(node.upperLimit || 50);
            $("#node-input-lowerLimit").val(node.lowerLimit || 30);

            // Ensure limits are numbers for comparison
            const editorUpperLimit = parseFloat(node.upperLimit) || 50;
            const editorLowerLimit = parseFloat(node.lowerLimit) || 30;

            $.getJSON(`/hysteresis-block-runtime/${this.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.upperLimit !== undefined && !isNaN(data.upperLimit) && parseFloat(data.upperLimit) !== parseFloat(editorUpperLimit)) {
                    changes.push(`upperLimit: ${data.upperLimit}`);
                }
                if (data.lowerLimit !== undefined && !isNaN(data.lowerLimit) && parseFloat(data.lowerLimit) !== parseFloat(editorLowerLimit)) {
                    changes.push(`lowerLimit: ${data.lowerLimit}`);
                }
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved by Node-RED
        },
        oneditvalidate: function() {
            const upper = parseFloat($("#node-input-upperLimit").val());
            const lower = parseFloat($("#node-input-lowerLimit").val());
            return !isNaN(upper) && !isNaN(lower) && upper > lower && upper >= 0 && lower >= 0;
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="hysteresis-block">
Evaluates numeric input against limits with hysteresis.

### Inputs
: context (string) : Configuration commands - thresholds (`"upperLimit"`, `"lowerLimit"`). Unmatched values trigger error.
: payload (number) : Input number for evaluation or new threshold value with `msg.context`.

### Outputs
: above (boolean) : `true` if input is in above state, else `false`.
: within (boolean) : `true` if input is in within state, else `false`.
: below (boolean) : `true` if input is in below state, else `false`.

### Properties
: name (string) : Display name in editor. Default: "" (shows "hysteresis").
: upperLimit (number) : Upper threshold for switching to above state (≥ 0, > lowerLimit). Default: 50.
: lowerLimit (number) : Lower threshold for switching to below state (≥ 0, < upperLimit). Default: 30.

### Details
Evaluates payload against `upperLimit` and `lowerLimit` with hysteresis, outputting new messages with `true` on one 
port (above, within, or below) and `false` on others. Uses hysteresis remains in "above" state until `msg.payload < lowerLimit`, "below" 
until `msg.payload > upperLimit`, or "within" until crossing a threshold. 

Outputs on every valid input.

### Status
- Green (dot): Configuration (e.g., `upperLimit: 50`, `lowerLimit: 30`).
- Blue (dot): Output (e.g., `out: within, in: 40.00`).
- Red (ring): Errors (e.g., `missing payload`, `invalid payload`, `invalid upperLimit`).
- Yellow (ring): Warnings (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>