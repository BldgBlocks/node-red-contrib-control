<!-- UI Template Section: Defines the edit dialog for the Interpolate Block node -->
<script type="text/html" data-template-name="interpolate-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-points" title="Default points table for interpolation (array of {x, y} objects, â‰¥2 points, x in ascending order)"><i class="fa fa-table"></i> Points</label>
        <textarea id="node-input-points" placeholder='[{"x": 0, "y": 0}, {"x": 100, "y": 100}]' style="height: 100px;"></textarea>
    </div>
</script>

<!-- JavaScript Section: Registers the node and handles editor logic -->
<script type="text/javascript">
    RED.nodes.registerType("interpolate-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "interpolate" },
            points: {
                value: JSON.stringify([{ x: 0, y: 0 }, { x: 100, y: 100 }]),
                required: true,
                validate: function(v) {
                    try {
                        const points = JSON.parse(v);
                        return Array.isArray(points) && points.length >= 2 &&
                               points.every(p => typeof p.x === "number" && !isNaN(p.x) &&
                                                 typeof p.y === "number" && !isNaN(p.y)) &&
                               points.slice(1).every((p, i) => p.x > points[i].x);
                    } catch (e) {
                        return false;
                    }
                }
            }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output"],
        icon: "font-awesome/fa-wrench",
        paletteLabel: "interpolate",
        label: function() {
            return this.name || "interpolate";
        },
        oneditprepare: function() {
            const id = this.id;
            // Initialize with pending client-side values
            $("#node-input-name").val(this.name || "interpolate");
            $("#node-input-points").val(this.points || JSON.stringify([{ x: 0, y: 0 }, { x: 100, y: 100 }], null, 2));

            // Fetch server data only for deployed nodes
            $.getJSON(`/interpolate-block/${id}?t=${Date.now()}`, function(data) {
                // Only update if node is deployed and data differs
                if (data && (data.name !== this.name || JSON.stringify(data.points) !== this.points)) {
                    $("#node-input-name").val(data.name || this.name || "interpolate");
                    $("#node-input-points").val(JSON.stringify(data.points || this.points || [{ x: 0, y: 0 }, { x: 100, y: 100 }], null, 2));
                }
            }.bind(this)).fail(function() {
                // No server data; rely on this properties (already set)
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved by Node-RED
        }
    });
</script>

<!-- Help Section: Provides documentation for the Interpolate Block node -->
<script type="text/markdown" data-help-name="interpolate-block">
Linearly interpolates a number input using a configurable points table.

### Inputs
- **context** <span class="property-type">string</span>
  Sets configuration ("points" to update {x, y} table).
- **payload** <span class="property-type">number | array</span>
  Number to interpolate, or points array for config.

### Outputs
- **payload** <span class="property-type">number</span>
  Interpolated output value.

### Details
The Interpolate Block linearly interpolates `msg.payload` (a number) using a table of `{x, y}` points (default: `[{x: 0, y: 0}, {x: 100, y: 100}]`). Points must be sorted by `x` in ascending order and contain at least two entries. The node supports both positive and negative slopes.

The node name and points are configurable in the editor. The points table can be updated via `msg.context = "points"` with `msg.payload` as an array of `{x, y}` objects. Editor changes require redeployment; message-based updates apply immediately and are reflected in the editor.

The node outputs a new message for every valid input within the points' x-range.

### Examples
- **Interpolate**: Input `{ payload: 50 }` with points `[{x: 0, y: 0}, {x: 100, y: 100}]`, output: `{ payload: 50 }`.
- **Update Points**: Input `{ context: "points", payload: [{x: 0, y: 10}, {x: 100, y: 20}] }`, no output, sets points.
- **Out of Range**: Input `{ payload: 150 }`, no output, shows "input out of range".

### Error Handling
- Missing `msg.payload`: Shows "missing input" or "missing payload" (red), no output.
- Invalid input (non-numeric): Shows "invalid input" (red), no output.
- Invalid points (non-array, <2 points, unsorted x, invalid {x, y}): Shows "invalid points" (red), no output.
- Unknown `msg.context`: Shows "unknown context" (yellow), no output.
- Input out of range: Shows "input out of range" (red), no output.

Status shows green for configuration (e.g., `points: 2`), blue for output (e.g., `in: 50.00, out: 50.00`), red for errors, yellow for unknown context.

### References
- [Node-RED Documentation](https://nodered.org/docs/) - official Node-RED documentation
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control) - source code and additional help
</script>