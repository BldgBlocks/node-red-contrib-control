<!-- UI Template Section: Defines the edit dialog -->
<script type="text/html" data-template-name="load-sequence-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-enable" title="Enable sequencing (boolean)"><i class="fa fa-power-off"></i> Enable</label>
        <input type="checkbox" id="node-input-enable" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-hysteresis" title="Hysteresis for threshold switching (non-negative number)"><i class="fa fa-exchange"></i> Hysteresis</label>
        <input type="number" id="node-input-hysteresis" placeholder="0.5" min="0" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-threshold1" title="Threshold for load 1 (number)"><i class="fa fa-arrow-up"></i> Threshold 1</label>
        <input type="number" id="node-input-threshold1" placeholder="10.0" min="0" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-threshold2" title="Threshold for load 2 (number, > threshold1)"><i class="fa fa-arrow-up"></i> Threshold 2</label>
        <input type="number" id="node-input-threshold2" placeholder="20.0" min="0" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-threshold3" title="Threshold for load 3 (number, > threshold2)"><i class="fa fa-arrow-up"></i> Threshold 3</label>
        <input type="number" id="node-input-threshold3" placeholder="30.0" min="0" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-threshold4" title="Threshold for load 4 (number, > threshold3)"><i class="fa fa-arrow-up"></i> Threshold 4</label>
        <input type="number" id="node-input-threshold4" placeholder="40.0" min="0" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-feedback1" title="Feedback for load 1 (boolean)"><i class="fa fa-refresh"></i> Feedback 1</label>
        <input type="checkbox" id="node-input-feedback1" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-feedback2" title="Feedback for load 2 (boolean)"><i class="fa fa-refresh"></i> Feedback 2</label>
        <input type="checkbox" id="node-input-feedback2" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-feedback3" title="Feedback for load 3 (boolean)"><i class="fa fa-refresh"></i> Feedback 3</label>
        <input type="checkbox" id="node-input-feedback3" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-feedback4" title="Feedback for load 4 (boolean)"><i class="fa fa-refresh"></i> Feedback 4</label>
        <input type="checkbox" id="node-input-feedback4" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section: Registers the node and handles editor logic -->
<script type="text/javascript">
    RED.nodes.registerType("load-sequence-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            enable: { value: true },
            hysteresis: { value: 0.5, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0; } },
            threshold1: { value: 10.0, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0; } },
            threshold2: { value: 20.0, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0; } },
            threshold3: { value: 30.0, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0; } },
            threshold4: { value: 40.0, required: true, validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) >= 0; } },
            feedback1: { value: true },
            feedback2: { value: true },
            feedback3: { value: true },
            feedback4: { value: true }
        },
        inputs: 1,
        outputs: 4,
        inputLabels: ["input"],
        outputLabels: ["load1", "load2", "load3", "load4"],
        icon: "font-awesome/fa-list-ol",
        paletteLabel: "load sequence",
        label: function() {
            return this.name || "load sequence";
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-name").val(node.name || "");
            $("#node-input-enable").prop("checked", node.enable !== false);
            $("#node-input-hysteresis").val(node.hysteresis || 0.5);
            $("#node-input-threshold1").val(node.threshold1 || 10.0);
            $("#node-input-threshold2").val(node.threshold2 || 20.0);
            $("#node-input-threshold3").val(node.threshold3 || 30.0);
            $("#node-input-threshold4").val(node.threshold4 || 40.0);
            $("#node-input-feedback1").prop("checked", node.feedback1 !== false);
            $("#node-input-feedback2").prop("checked", node.feedback2 !== false);
            $("#node-input-feedback3").prop("checked", node.feedback3 !== false);
            $("#node-input-feedback4").prop("checked", node.feedback4 !== false);

            $.getJSON(`/load-sequence-block-runtime/${this.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.enable !== node.enable) changes.push(`enable: ${data.enable}`);
                if (data.hysteresis !== undefined && !isNaN(data.hysteresis) && parseFloat(data.hysteresis) !== parseFloat(node.hysteresis || 0.5)) {
                    changes.push(`hysteresis: ${data.hysteresis}`);
                }
                if (data.threshold1 !== undefined && !isNaN(data.threshold1) && parseFloat(data.threshold1) !== parseFloat(node.threshold1 || 10.0)) {
                    changes.push(`threshold1: ${data.threshold1}`);
                }
                if (data.threshold2 !== undefined && !isNaN(data.threshold2) && parseFloat(data.threshold2) !== parseFloat(node.threshold2 || 20.0)) {
                    changes.push(`threshold2: ${data.threshold2}`);
                }
                if (data.threshold3 !== undefined && !isNaN(data.threshold3) && parseFloat(data.threshold3) !== parseFloat(node.threshold3 || 30.0)) {
                    changes.push(`threshold3: ${data.threshold3}`);
                }
                if (data.threshold4 !== undefined && !isNaN(data.threshold4) && parseFloat(data.threshold4) !== parseFloat(node.threshold4 || 40.0)) {
                    changes.push(`threshold4: ${data.threshold4}`);
                }
                if (data.feedback1 !== node.feedback1) changes.push(`feedback1: ${data.feedback1}`);
                if (data.feedback2 !== node.feedback2) changes.push(`feedback2: ${data.feedback2}`);
                if (data.feedback3 !== node.feedback3) changes.push(`feedback3: ${data.feedback3}`);
                if (data.feedback4 !== node.feedback4) changes.push(`feedback4: ${data.feedback4}`);
                if (data.out1 !== false) changes.push(`out1: ${data.out1}`);
                if (data.out2 !== false) changes.push(`out2: ${data.out2}`);
                if (data.out3 !== false) changes.push(`out3: ${data.out3}`);
                if (data.out4 !== false) changes.push(`out4: ${data.out4}`);
                if (data.dOn !== 0) changes.push(`dOn: ${data.dOn}`);
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved by Node-RED
        },
        oneditvalidate: function() {
            const hysteresis = parseFloat($("#node-input-hysteresis").val());
            const threshold1 = parseFloat($("#node-input-threshold1").val());
            const threshold2 = parseFloat($("#node-input-threshold2").val());
            const threshold3 = parseFloat($("#node-input-threshold3").val());
            const threshold4 = parseFloat($("#node-input-threshold4").val());
            return !isNaN(hysteresis) && hysteresis >= 0 &&
                   !isNaN(threshold1) && !isNaN(threshold2) && !isNaN(threshold3) && !isNaN(threshold4) &&
                   threshold1 >= 0 && threshold2 >= 0 && threshold3 >= 0 && threshold4 >= 0 &&
                   threshold1 < threshold2 && threshold2 < threshold3 && threshold3 < threshold4;
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="load-sequence-block">
Sequences four boolean outputs based on input thresholds with feedback and hysteresis.

### Inputs
: context (string) : Configures settings (`"enable"`, `"hysteresis"`, `"threshold1-4"`, `"feedback1-4"`). Unmatched values trigger error.
: payload (number | string | boolean) : Number for input, `"kill"` to shut down, boolean for `enable`/`feedback1-4`, number for `hysteresis`/`threshold1-4`.

### Outputs
: load1 (boolean) : `true` when active, else `false` or `null`.
: load2 (boolean) : `true` when active, else `false` or `null`.
: load3 (boolean) : `true` when active, else `false` or `null`.
: load4 (boolean) : `true` when active, else `false` or `null`.

### Properties
: name (string) : Display name in editor. Default: "" (shows "load sequence").
: enable (boolean) : Enables sequencing. Default: `true`.
: hysteresis (number) : Hysteresis for threshold switching (≥ 0). Default: 0.5.
: threshold1 (number) : Threshold for load 1 (≥ 0). Default: 10.0.
: threshold2 (number) : Threshold for load 2 (≥ 0, > threshold1). Default: 20.0.
: threshold3 (number) : Threshold for load 3 (≥ 0, > threshold2). Default: 30.0.
: threshold4 (number) : Threshold for load 4 (≥ 0, > threshold3). Default: 40.0.
: feedback1 (boolean) : Feedback for load 1. Default: `true`.
: feedback2 (boolean) : Feedback for load 2. Default: `true`.
: feedback3 (boolean) : Feedback for load 3. Default: `true`.
: feedback4 (boolean) : Feedback for load 4. Default: `true`.

### Details
Sequences four boolean outputs (`load1` to `load4`) based on `msg.payload` (number) crossing `threshold1` to `threshold4` with `hysteresis` 
and `feedback1-4`. Outputs turn on when input exceeds a threshold and prior feedback is `true` (e.g., `load2` requires `feedback1`). 

Outputs turn off when input falls below `thresholdX - hysteresis` and higher-stage feedback allows. Configurable via editor or `msg.context`. 

`msg.payload = "kill"` shuts down all outputs. `enable = false` disables outputs sequentially (highest to lowest). 

Tracks active stages (`dOn`). Outputs new messages only when a state changes, sending a single non-null message for the lowest stage that changed. 

### Status
- Green (dot): Configuration (e.g., `threshold1: 10`, `enable: true`).
- Blue (dot): Output (e.g., `in: 25.00, out: [true, true, false, false]`).
- Blue (ring): Unchanged (e.g., `in: 25.00, out: [true, true, false, false]`).
- Red (dot): Kill (e.g., `kill: all off`).
- Red (ring): Errors (e.g., `invalid payload`, `invalid threshold order`).
- Yellow (ring): Warnings (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>