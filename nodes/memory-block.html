<!-- UI Template Section -->
<script type="text/html" data-template-name="memory-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-writePeriod" title="Delay in milliseconds before writing to file (non-negative number from msg, flow, global, or static value)"><i class="fa fa-clock-o"></i> File Write Period (ms)</label>
        <input type="text" id="node-input-writePeriod" placeholder="60000">
        <input type="hidden" id="node-input-writePeriodType">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("memory-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            writePeriod: { value: "60000" },
            writePeriodType: { value: "num" }
        },
        inputs: 1,
        outputs: 2,
        inputLabels: ["input"],
        outputLabels: ["query", "value"],
        icon: "font-awesome/fa-database",
        paletteLabel: "memory",
        label: function() {
            return this.name || "memory";
        },
        oneditprepare: function() {
            const node = this;
            const writePeriodType = node.writePeriodType || "num";
            const writePeriodValue = node.writePeriod || "60000";

            $("#node-input-name").val(node.name || "");

            const periodInput = $("#node-input-writePeriod").typedInput({
                default: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-writePeriodType"
            });

            periodInput.typedInput("type", writePeriodType);
            periodInput.typedInput("value", writePeriodValue);

            $.getJSON(`/memory-block-runtime/${node.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.writePeriod !== undefined && data.writePeriodType === "num" && Number(data.writePeriod) !== Number(node.writePeriod || 60000)) {
                    changes.push(`writePeriod: ${Number(data.writePeriod).toFixed(0)} ms`);
                }
                if (data.storedMsg && data.storedMsg.payload != null) {
                    const payloadStr = String(data.storedMsg.payload).substring(0, 20);
                    changes.push(`stored: ${payloadStr}`);
                }
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            $("#node-input-writePeriodType").val($("#node-input-writePeriod").typedInput("type"));
        },
        oneditvalidate: function() {
            const writePeriod = $("#node-input-writePeriod").typedInput("value");
            const writePeriodType = $("#node-input-writePeriod").typedInput("type");
            if (writePeriodType === "num") {
                const value = parseFloat(writePeriod);
                return !isNaN(value) && isFinite(value) && value >= 0;
            }
            return true;
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="memory-block">
Stores a message persistently across reboots and redeployments, with delayed file writes.

### Inputs
: context (string) : Action (`"update"` to store message, `"execute"` to output stored message, `"executeWithFallback"` to output stored message or store and output fallback, `"query"` to check stored value existence).
: payload (any) : Value to store (`"update"`, `"executeWithFallback"`) or pass through (no `context`).

### Outputs
: Output 1 (query) : For `context = "query"`: `{ payload: boolean }` (`true` if stored value exists, `false` if none).
: Output 2 (value) : For no `context`: Input `msg` unchanged. For `context = "execute"`: Stored `msg` or `{ payload: null }` if none. For `context = "executeWithFallback"`: Stored `msg` or `{ payload: msg.payload }` if none (stores `msg.payload`). For `context = "update"`: No output.

### Properties
: name (string) : Display name in editor. Default: "" (shows "memory").
: writePeriod (string) : Delay in milliseconds before writing to file (non-negative, from `msg`, `flow`, `global`, or static). Default: "60000".
: writePeriodType (string) : Source of `writePeriod` (`"num"`, `"msg"`, `"flow"`, `"global"`). Default: `"num"`.

### Details
Stores a single message persistently in a JSON file, surviving Node-RED reboots and redeployments. Uses delayed file writes to minimize I/O. Actions:
- `msg.context = "update"`: Stores `msg`, schedules file write after `writePeriod` (ms, default 60000). Only the last update within the period is written. No output.
- `msg.context = "execute"`: Outputs stored `msg` to Output 2 if available, or `{ payload: null }` if none. No file write.
- `msg.context = "executeWithFallback"`: Outputs stored `msg` to Output 2 if available; if none, stores `msg.payload` as new message, schedules file write, and outputs `{ payload: msg.payload }`.
- `msg.context = "query"`: Outputs `{ payload: true }` to Output 1 if a stored value exists, `{ payload: false }` if none. No file write or Output 2 message.
- No `msg.context`: Passes input `msg` unchanged to Output 2, no effect on stored `msg` or file.
Configurable via editor (`name`, `writePeriod`). `writePeriod` resolved dynamically, defaults to 60000ms if invalid. Runtime values (`name`, `writePeriod`, `storedMsg.payload`) shown in "Changed Runtime Values" if non-default.

### Error Handling
- Missing `msg`: No output, red status (`invalid message`).
- Missing `msg.payload` for `"update"`, `"executeWithFallback"`: No output, red status (`missing payload`).
- Invalid `msg.context` (non-string, not `"update"`, `"execute"`, `"executeWithFallback"`, `"query"`): No output, yellow status (`unknown context`), errors with message.
- Invalid `writePeriod` (non-numeric, non-finite, negative): Red status (`invalid write period`), defaults to 60000ms.
- File I/O errors: Red status (`file error`), continues in-memory operation.

### Status
- Green (dot): Load or update (e.g., `loaded: 42`, `updated: 42`).
- Blue (dot): Pass-through, execute, executeWithFallback, or query (e.g., `in: test, out2: test`, `in: execute, out2: 42`, `in: executeWithFallback, out2: 42`, `in: query, out1: true`).
- Red (ring): Errors (e.g., `missing payload`, `invalid write period`, `file error`).
- Yellow (ring): Unknown context (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>