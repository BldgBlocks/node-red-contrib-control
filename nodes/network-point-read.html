<script type="text/html" data-template-name="network-point-read">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Point #101">
    </div>
    <div class="form-row">
        <label for="node-input-pointId" title="Point ID to cache (e.g., 301)"><i class="fa fa-hashtag"></i> Point ID</label>
        <input type="number" id="node-input-pointId" placeholder="301" min="0" required>
    </div>
    <hr style="margin: 10px 0;">
    <div class="form-row">
        <label for="node-input-outputProperty" title="Set output message property"><i class="fa fa-arrow-right"></i> Target</label>
        <input type="text" id="node-input-outputProperty" placeholder="payload">
    </div>
    <div class="form-row">
        <label for="node-input-bridgeNodeId" title="Select which network bridge to query"><i class="fa fa-link"></i> Network Bridge</label>
        <input type="text" id="node-input-bridgeNodeId" style="width: calc(70% - 45px);">
        <button id="node-config-find-bridge" class="editor-button" style="margin-left: 5px; width: 40px;" title="Find Bridge Node">
            <i class="fa fa-search"></i>
        </button>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("network-point-read", {
        category: "bldgblocks network",
        color: "#3090C7",
        defaults: {
            name: { value: "" },
            outputProperty: { value: "payload" },
            pointId: { 
                value: 0, 
                required: true,
                validate: function(v) { 
                    return !isNaN(parseInt(v)) && parseInt(v) >= 0; 
                }
            },
            bridgeNodeId: { 
                value: "", 
                required: true
            }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["trigger (from inject/timer)"],
        outputLabels: ["value update / response"],
        icon: "font-awesome/fa-refresh",
        paletteLabel: "network point read",
        label: function() {
            const id = this.pointId ? ` #${this.pointId}` : " (unconfigured)";
            const bridgeName = this.bridgeNodeId ? ` â†’ ${RED.nodes.node(this.bridgeNodeId)?.name || "bridge"}` : "";
            return this.name ? `${this.name}${id}${bridgeName}` : `network point read${id}${bridgeName}`;
        },
        oneditprepare: function() {
            const node = this;
            
            let candidateNodes = [];
            RED.nodes.eachNode(function(n) {
                if (n.type === 'network-service-bridge') {
                    candidateNodes.push({
                        value: n.id,
                        label: n.name || "(unnamed bridge)"
                    });
                }
            });

            candidateNodes.sort((a, b) => a.label.localeCompare(b.label));

            $("#node-input-bridgeNodeId").typedInput({
                types: [{ value: "bridge", options: candidateNodes }]
            });
$("#node-input-outputProperty").typedInput({
                types: ['msg']
            });

            
            // Find button
            $("#node-config-find-bridge").on("click", function() {
                if (node.bridgeNodeId) {
                    RED.viewport.reveal(node.bridgeNodeId);
                }
            });
        },
        oneditsave: function() {
            // Optional: log configuration
        }
    });
</script>

<script type="text/markdown" data-help-name="network-point-read">
Caches a remote point value and serves requests immediately (non-blocking).

Ideal for flows that need current point values without waiting for network latency.

### Inputs
: action (string) : Command - `getPoint` to request cached value, `resetCache` to clear cache.
: pointId (number) : The remote point ID to query (e.g., 301).
: payload (any) : Trigger message from inject or timer node.

### Outputs
: payload (number | string | boolean) : Cached point value on update.
: pointId (number) : Echo of queried point ID.
: cached (boolean) : true if value served from cache, false if fresh from network.
: age (number) : Cache age in milliseconds.
: action (string) : getPointResponse or pointUpdate.

### Details
Caching Architecture:
1. External trigger - Inject node controls polling timing
2. Event-based communication - Sends request to selected bridge
3. Immediate serving - Returns cached value on getPoint requests
4. Non-blocking - Logic flows never wait for network roundtrip

Use With:
- network-service-bridge - Routes requests via WebSocket
- History nodes - Feed cached poi

### Status
- Green (dot): Configuration update
- Blue (dot): State changed
- Blue (ring): State unchanged
- Red (ring): Error
- Yellow (ring): Warning

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>
