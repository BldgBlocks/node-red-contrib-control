<script type="text/html" data-template-name="network-point-register">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-registry" title="A group of id's for assignment organization"><i class="fa fa-book"></i> Registry</label>
        <input type="text" id="node-input-registry">
    </div>
    
    <div class="form-row">
        <label for="node-input-pointId" title="Simple, stable, and unique lookup id for network users."><i class="fa fa-hashtag"></i> Point ID</label>
        <div style="display: inline-block; width: 70%;">
            <input type="number" id="node-input-pointId" placeholder="e.g. 101" style="width: 100px;">
            <span id="point-id-status" style="margin-left: 10px; display: none;"></span>
        </div>
    </div>

    <div class="form-row">
        <label for="node-input-writable"><i class="fa fa-pencil"></i> Writable</label>
        <input type="checkbox" id="node-input-writable" style="display: inline-block; width: auto; vertical-align: top;">
        <span style="color: #666;"> Allow network to write to this point?</span>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("network-point-register", {
        category: 'bldgblocks network',
        color: '#3090C7',
        defaults: {
            name: { value: "" },
            registry: { value: "", type: "network-service-registry", required: true },
            pointId: { value: null, required: true, validate: RED.validators.number() },
            writable: { value: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-book",
        label: function() {
            const id = this.pointId || "?";
            return `(id:${id}) ${this.name || "network point register"}`;
        },
        paletteLabel: "network point register",
        onadd: function() {
            // Fires when node is added to workspace (including paste/import)
            const node = this;
            const registry = node.registry;
            
            if (!registry || registry === "_ADD_") return;
            
            // Find max pointId and check for collision
            let maxId = 0;
            let collision = false;
            const myId = parseInt(node.pointId);
            
            RED.nodes.eachNode(function(n) {
                if (n.type === "network-point-register" && n.registry === registry && n.id !== node.id) {
                    const pid = parseInt(n.pointId);
                    if (!isNaN(pid)) {
                        if (pid > maxId) maxId = pid;
                        if (pid === myId) collision = true;
                    }
                }
            });
            
            // If collision or no pointId, assign next available
            if (collision || isNaN(myId) || myId === null) {
                node.pointId = maxId + 1;
                node.changed = true;
            }
        },
        oneditprepare: function() {
            const nodeId = this.id;
            const statusSpan = $("#point-id-status");
            const idInput = $("#node-input-pointId");
            const regInput = $("#node-input-registry");

            let timer = null;

            function checkId() {
                const node = this;
                const pid = idInput.val();
                const rid = regInput.val();

                statusSpan.hide();
                idInput.removeClass("input-error");
                
                if (timer) clearTimeout(timer);

                // Need both ID and Registry selected to validate
                if (pid && rid && rid !== "_ADD_") {
                    timer = setTimeout(() => {
                        // Pass Registry ID in URL
                        $.getJSON(`network-point-registry/check/${rid}/${pid}/${nodeId}`, function(data) {
                            if (data.warning) {
                                // Registry exists in config but not deployed
                                statusSpan.html(`<i class="fa fa-question-circle" style="color: orange;" title="${data.warning}"></i> Not Deployed`).show();
                            } else if (data.status === "collision") {
                                // Conflict
                                statusSpan.html('<i class="fa fa-exclamation-triangle" style="color: red;"></i> ID Taken').show();
                                idInput.addClass("input-error");
                            } else if (data.status === "assigned") {
                                // Assigned here
                                statusSpan.html('<i class="fa fa-check" style="color: green;"></i> Assigned').show();
                            } else {
                                // Available
                                statusSpan.html('<i class="fa fa-check" style="color: green;"></i> Available').show();
                            }
                        });
                    }, 500);
                }
            }

            function loadNextFreeId(registry) {
                if (!registry || registry === "_ADD_") { return; }
                
                // First, find highest pointId from ALL nodes in editor (deployed + not deployed)
                let maxEditorId = 0;
                RED.nodes.eachNode(function(n) {
                    if (n.type === "network-point-register" && n.registry === registry && n.id !== nodeId) {
                        const pid = parseInt(n.pointId);
                        if (!isNaN(pid) && pid > maxEditorId) {
                            maxEditorId = pid;
                        }
                    }
                });

                // Also check deployed registry for any points not visible in editor
                $.getJSON(`/network-point-registry/list/${registry}`, function (data) {
                    const maxDeployedId = data.reduce((max, pt) => Math.max(max, pt.id), 0);
                    const next = Math.max(maxEditorId, maxDeployedId) + 1;
                    idInput.val(next);
                }).fail(function () {
                    // Fallback to editor-only max if server unavailable
                    const next = maxEditorId + 1;
                    idInput.val(next);
                    if (maxEditorId === 0) {
                        statusSpan.html('<i class="fa fa-exclamation-triangle" style="color:orange;"></i> Registry not deployed').show();
                    }
                });
            }

            // Trigger check on ID type or Registry Change
            idInput.on("input", checkId);
            regInput.on("change", function () {
                checkId();
                if (idInput.val().trim() === "") {
                    loadNextFreeId(regInput.val());
                }
            });
            
            if (idInput.val().trim() === "") {
                loadNextFreeId(regInput.val());
            }
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="network-point-register">
Register a data point in a network registry for shared access across devices, similar to BACnet usage.

### Inputs
: payload (object) : Expected flow from global-setter containing full network object properties.

### Outputs
: payload (any) : Current value of the registered network point.

### Details
Network Register nodes make data points discoverable from anywhere by assigning them a stable numeric ID within a registry.

Each point requires a unique Point ID within its registry. The Point ID is used by other nodes (network-read, network-write) to reference this point without needing node links.

Registry must be configured via a network-point-registry config node. Each registry is a separate namespace for point IDs.

The Writable checkbox controls whether network-write nodes can update this point's value. Disabled by default.

Usage: Set up your networking implementation, maybe websockets communication, discover available points using `action: "discover"` from that device for a list you can build from and set up network read flows to retrieve the data.

Point ID Status:
- Green check: Available or assigned to this node
- Orange question: Registry not deployed  
- Red exclamation: Point ID is taken by another node in the same registry

The editor will auto-suggest the next available Point ID when creating a new node.

### Status
- Green (dot): Configuration update
- Blue (dot): State changed
- Blue (ring): State unchanged
- Red (ring): Error
- Yellow (ring): Warning

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>
