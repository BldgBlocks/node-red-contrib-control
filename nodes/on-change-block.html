<!-- UI Template Section -->
<script type="text/html" data-template-name="on-change-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-period" title="Filter period in milliseconds (non-negative number from msg, flow, global, or static value)"><i class="fa fa-clock-o"></i> Filter Period (ms)</label>
        <input type="text" id="node-input-period" placeholder="0">
        <input type="hidden" id="node-input-periodType">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("on-change-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            period: { value: 0 },
            periodType: { value: "num" }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output"],
        icon: "font-awesome/fa-filter",
        paletteLabel: "on change",
        label: function() {
            return this.name || "on change";
        },
        oneditprepare: function() {
            const node = this;
            const periodType = node.periodType || "num";
            const periodValue = node.period !== undefined ? node.period : 0;

            const periodInput = $("#node-input-period").typedInput({
                default: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-periodType"
            });

            periodInput.typedInput("type", periodType);
            periodInput.typedInput("value", periodValue);

            $("#node-input-name").val(node.name || "");

            $.getJSON(`/on-change-block-runtime/${node.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.period !== undefined && !isNaN(data.period) && data.period !== Number(node.period) && data.periodType === node.periodType) {
                    changes.push(`period: ${data.period.toFixed(0)} ms`);
                }
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            $("#node-input-periodType").val($("#node-input-period").typedInput("type"));
        },
        oneditvalidate: function() {
            const period = parseFloat($("#node-input-period").typedInput("value"));
            return !isNaN(period) && period >= 0;
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="on-change-block">
Filters redundant messages based on value changes and a configurable period.

### Inputs
: payload (any) : Input value to compare.
: context (string, optional) : Configures period (`"period"`) or queries state (`"status"`).
: payload (number | any, for `context`) : Non-negative number for `"period"` (ms), any for `"status"`.

### Outputs
: msg (any) : Input message if value changed and not filtered.
: payload (object, for `msg.context = "status"`) : `{ period, periodType }`.

### Properties
: name (string) : Display name in editor. Default "" (shows "on change").
: period (number) : Filter period in milliseconds (â‰¥ 0, static or from `msg`, `flow`, `global`). Default 0.
: periodType (string) : Source of period (`"num"`, `"msg"`, `"flow"`, `"global"`). Default `"num"`.

### Details
Filters messages based on value changes (deep comparison) and a filter period. When `period = 0`, outputs the input message only if `msg.payload` differs from the last output value. When `period > 0`, outputs the first message, suppresses all messages during the period (including blips), and after the period, outputs only if the value differs from the last output. Supports complex payloads (objects, arrays) via deep comparison. Configuration:
- `msg.context = "period"`: Sets period (ms), no output.
- `msg.context = "status"`: Outputs `{ period, periodType }`.
Unknown `msg.context` is ignored, processing `msg.payload`. Editor changes require redeployment; message-based period updates apply immediately. Runtime values (`name`, `period`) shown in "Changed Runtime Values" if different from defaults. Used in control systems to debounce or filter redundant sensor data.

### Error Handling
- Missing `msg`: No output, red status (`invalid message`).
- Missing `msg.payload`: Message passed, red status (`missing payload`).
- Invalid period (non-numeric, negative): Message passed, red status (`invalid period`), uses default (0).
- Invalid `msg.context`: Ignored, message processed as passthrough.

### Status
- Green (dot): Configuration (e.g., `name: on change, period: 500 ms`, `period: 1000 ms`).
- Blue (dot): Output (e.g., `out: true`).
- Blue (ring): Filtered or unchanged (e.g., `filtered: false`, `unchanged: true`).
- Red (ring): Errors (e.g., `invalid message`, `invalid period`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control)
</script>