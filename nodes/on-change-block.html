<!-- UI Template Section -->
<script type="text/html" data-template-name="on-change-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-period" title="Filter period in milliseconds (non-negative number from msg, flow, global, or static value)"><i class="fa fa-clock-o"></i> Filter Period (ms)</label>
        <input type="text" id="node-input-period" placeholder="0">
        <input type="hidden" id="node-input-periodType">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("on-change-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            period: { value: 0 },
            periodType: { value: "num" }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output"],
        icon: "font-awesome/fa-filter",
        paletteLabel: "on change",
        label: function() {
            return this.name || "on change";
        },
        oneditprepare: function() {
            const node = this;
            const periodType = node.periodType || "num";
            const periodValue = node.period !== undefined ? node.period : 0;

            const periodInput = $("#node-input-period").typedInput({
                default: "num",
                types: ["num", "msg", "flow", "global"],
                typeField: "#node-input-periodType"
            });

            periodInput.typedInput("type", periodType);
            periodInput.typedInput("value", periodValue);

            $("#node-input-name").val(node.name || "");

            $.getJSON(`/on-change-block-runtime/${node.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.period !== undefined && !isNaN(data.period) && data.period !== Number(node.period) && data.periodType === node.periodType) {
                    changes.push(`period: ${data.period.toFixed(0)} ms`);
                }
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            $("#node-input-periodType").val($("#node-input-period").typedInput("type"));
        },
        oneditvalidate: function() {
            const period = parseFloat($("#node-input-period").typedInput("value"));
            return !isNaN(period) && period >= 0;
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="on-change-block">
Passes the input message immediately, then blocks messages for a specified period.

### Inputs
: context (string) : Configures period (`"period"`) or queries state (`"status"`). Unmatched values trigger error.
: payload (any) : Input value to compare, or non-negative number for period config.

### Outputs
: payload (any) : Input payload if not blocked; for `msg.context = "status"`, `{ period, periodType }`.
: Other input message properties (e.g., `msg.topic`) are preserved, except for `msg.context = "status"`.

### Properties
: name (string) : Display name in editor. Default: "" (shows "on change").
: period (number) : Filter period in milliseconds (â‰¥ 0, static or from `msg`, `flow`, `global`). Default: 0.
: periodType (string) : Source of period (`"num"`, `"msg"`, `"flow"`, `"global"`). Default: `"num"`.

### Details
Sends the first input message immediately, then blocks messages for `period` milliseconds (default: 0, pass only changed values). During block, identical messages (deep comparison) show "unchanged" status, different messages show "blocked", with no output. After period, the next message is sent immediately, restarting the block. Period configurable via editor (static or `msg`, `flow`, `global`) or `msg.context = "period"` with non-negative numeric `msg.payload` (milliseconds). Set `period = 0` to pass only changed values (deep comparison for objects/arrays). `msg.context = "status"` outputs `{ period, periodType }`. Editor changes require redeployment; message-based period updates apply immediately. Runtime values (`name`, `period`) shown in "Changed Runtime Values" if different from defaults.

### Error Handling
- Missing `msg`: No output, red status (`invalid message`).
- Missing `msg.payload`: No output, red status (`missing payload`).
- Invalid period (non-numeric, negative): Red status (`invalid period`), uses default (0).
- Unknown `msg.context`: No output, yellow status (`unknown context`), errors with message.

### Status
- Green (dot): Configuration (e.g., `period: 500 ms`).
- Blue (dot): Output (e.g., `out: 10`).
- Blue (ring): Blocked or unchanged (e.g., `blocked: 20`, `unchanged: 10`).
- Red (ring): Errors (e.g., `missing payload`, `invalid period`).
- Yellow (ring): Unknown context (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control)
</script>