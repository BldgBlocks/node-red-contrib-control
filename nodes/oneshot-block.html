<!-- UI Template Section -->
<script type="text/html" data-template-name="oneshot-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-duration" title="Duration of true pulse (ms, positive integer)"><i class="fa fa-clock-o"></i> Duration (ms)</label>
        <input type="number" id="node-input-duration" placeholder="1000" min="1" step="1">
    </div>
    <div class="form-row">
        <label for="node-input-triggerOnTrue" title="Require msg.payload = true to trigger"><i class="fa fa-check"></i> Trigger on true</label>
        <input type="checkbox" id="node-input-triggerOnTrue" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("oneshot-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            duration: { 
                value: 1000, 
                required: true, 
                validate: function(v) { return Number.isInteger(Number(v)) && Number(v) >= 1; } 
            },
            triggerOnTrue: { value: false }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["trigger/reset"],
        outputLabels: ["pulse"],
        icon: "font-awesome/fa-bolt",
        paletteLabel: "oneshot",
        label: function() {
            return this.name || `oneshot (${this.duration}ms)`;
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-name").val(node.name || "");
            $("#node-input-duration").val(node.duration || 1000);
            $("#node-input-triggerOnTrue").prop("checked", node.triggerOnTrue !== false);

            $.getJSON(`/oneshot-block-runtime/${this.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.duration !== undefined && Number.isInteger(data.duration) && data.duration !== (Number(node.duration) || 1000)) {
                    changes.push(`duration: ${data.duration}`);
                }
                if (data.triggerOnTrue !== node.triggerOnTrue) changes.push(`triggerOnTrue: ${data.triggerOnTrue}`);
                if (data.triggerCount !== 0) changes.push(`triggerCount: ${data.triggerCount}`);
                if (data.locked !== false) changes.push(`locked: ${data.locked}`);
                if (data.output !== false) changes.push(`output: ${data.output}`);
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved by Node-RED
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="oneshot-block">
Outputs a true pulse for a configurable duration when triggered, then false, and locks until reset.

### Inputs
: context (string) : Unlocks node (`"reset"`). Unmatched values trigger error.
: payload (any) : Triggers pulse if not locked. If `triggerOnTrue = true`, requires `msg.payload = true`.

### Outputs
: payload (boolean) : `true` for `duration` on trigger, then `false`; `false` on reset or if locked/ignored.

### Properties
: name (string) : Display name in editor. Default: "" (shows "oneshot (duration ms)").
: duration (integer) : Pulse duration in milliseconds (≥ 1). Default: 1000.
: triggerOnTrue (boolean) : Require `msg.payload = true` to trigger. Default: `false`.

### Details
Generates a `true` pulse for `duration` (milliseconds, default: 1000) when triggered, then outputs `false` and locks until `msg.context = "reset"`. Triggers on any `msg.payload` if `triggerOnTrue = false`, or only `msg.payload = true` if `triggerOnTrue = true`. Tracks `triggerCount` (number of triggers) and displays in status. Outputs new messages for every trigger (`true` then `false`), reset, or locked/ignored input. Configurable via editor (`name`, `duration`, `triggerOnTrue`). Editor changes require redeployment; reset commands apply immediately. Runtime values (`name`, `duration`, `triggerOnTrue`, `triggerCount`, `locked`, `output`) are shown in "Changed Runtime Values" if different from defaults.

### Error Handling
- Missing `msg`: No output, red status (`invalid message`).
- Invalid `duration` (non-integer, < 1): Red status (`invalid duration`), uses 1000ms.
- Locked input: Outputs `false`, red status (`triggers: X, locked`).
- Ignored input (`triggerOnTrue = true`, `msg.payload ≠ true`): Outputs `false`, yellow status (`triggers: X, ignored`).
- Unknown `msg.context`: No output, yellow status (`unknown context`), errors with message.

### Status
- Green (dot): Trigger (e.g., `triggers: 1, out: true`).
- Blue (dot): Reset (e.g., `triggers: 1, reset`).
- Blue (ring): Initial (e.g., `triggers: 0, unlocked`).
- Red (ring): Locked or error (e.g., `triggers: 1, locked`, `invalid duration`).
- Yellow (ring): Ignored or unknown context (e.g., `triggers: 1, ignored`, `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control)
</script>