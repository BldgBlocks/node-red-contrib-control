<!-- UI Template Section -->
<script type="text/html" data-template-name="oneshot-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-duration" title="Duration of true pulse (positive number)"><i class="fa fa-clock-o"></i> Duration</label>
        <input type="number" id="node-input-duration" placeholder="1000" min="0" step="any">
        <select id="node-input-durationUnits">
            <option value="milliseconds">Milliseconds</option>
            <option value="seconds">Seconds</option>
            <option value="minutes">Minutes</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-resetRequireTrue" title="Require msg.payload = true for reset"><i class="fa fa-check"></i> Reset Require True</label>
        <input type="checkbox" id="node-input-resetRequireTrue" style="width: auto; vertical-align: middle;" checked>
    </div>
    <div class="form-row">
        <label for="node-input-resetOnComplete" title="Automatically reset (unlock) after pulse duration"><i class="fa fa-undo"></i> Reset On Complete</label>
        <input type="checkbox" id="node-input-resetOnComplete" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <pre id="node-runtime-changes" style="color: #555; white-space: pre-wrap;">Changed Values: None</pre>
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("oneshot-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            duration: { 
                value: 1000, 
                required: true, 
                validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) > 0; } 
            },
            durationUnits: { value: "milliseconds" },
            resetRequireTrue: { value: true },
            resetOnComplete: { value: false }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["trigger/reset"],
        outputLabels: ["pulse"],
        icon: "font-awesome/fa-bolt",
        paletteLabel: "oneshot",
        label: function() {
            return this.name || `oneshot (${this.duration}${this.durationUnits.charAt(0)})`;
        },
        oneditprepare: function() {
            const node = this;
            $("#node-input-name").val(node.name || "");
            $("#node-input-duration").val(node.duration || 1000);
            $("#node-input-durationUnits").val(node.durationUnits || "milliseconds");
            $("#node-input-resetRequireTrue").prop("checked", node.resetRequireTrue !== false);
            $("#node-input-resetOnComplete").prop("checked", node.resetOnComplete || false);

            $.getJSON(`/oneshot-block-runtime/${this.id}?t=${Date.now()}`, function(data) {
                const changes = [];
                if (data.name) changes.push(`name: ${data.name}`);
                if (data.duration !== undefined && !isNaN(data.duration) && data.duration !== (Number(node.duration) * (node.durationUnits === "seconds" ? 1000 : node.durationUnits === "minutes" ? 60000 : 1))) {
                    changes.push(`duration: ${data.duration.toFixed(0)} ms`);
                }
                if (data.durationUnits !== node.durationUnits) changes.push(`durationUnits: ${data.durationUnits}`);
                if (data.resetRequireTrue !== node.resetRequireTrue) changes.push(`resetRequireTrue: ${data.resetRequireTrue}`);
                if (data.resetOnComplete !== node.resetOnComplete) changes.push(`resetOnComplete: ${data.resetOnComplete}`);
                if (data.triggerCount !== 0) changes.push(`triggerCount: ${data.triggerCount}`);
                if (data.locked !== false) changes.push(`locked: ${data.locked}`);
                if (data.output !== false) changes.push(`output: ${data.output}`);
                $("#node-runtime-changes").text(changes.length > 0 ? `Changed Values:\n${changes.join("\n")}` : "Changed Values: None");
            }).fail(function() {
                $("#node-runtime-changes").text("Changed Values: Unknown");
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved by Node-RED
        },
        oneditvalidate: function() {
            const duration = parseFloat($("#node-input-duration").val());
            return !isNaN(duration) && duration > 0;
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="oneshot-block">
Outputs a true pulse for a configurable duration when triggered with `msg.payload = true`, then false, and locks until reset.

### Inputs
: context (string) : Configures node (`"reset"`, `"duration"`). Unmatched values trigger error.
: payload (boolean | number) : `true` triggers pulse if not locked; number for `"duration"`; boolean for `"reset"`.
: units (string) : Units for `"duration"` (`"milliseconds"`, `"seconds"`, `"minutes"`).

### Outputs
: payload (boolean) : `true` for `duration` on trigger, then `false`; `false` on reset or if locked.

### Properties
: name (string) : Display name in editor. Default: "" (shows "oneshot (duration unit)").
: duration (number) : Pulse duration (positive number). Default: 1000.
: durationUnits (string) : Units for duration (`"milliseconds"`, `"seconds"`, `"minutes"`). Default: `"milliseconds"`.
: resetRequireTrue (boolean) : Require `msg.payload = true` for reset. Default: `true`.
: resetOnComplete (boolean) : Automatically reset (unlock) after pulse duration. Default: `false`.

### Details
Generates a `true` pulse for `duration` (converted to milliseconds, default: 1000ms) when triggered with `msg.payload = true`, 
then outputs `false`. 

Locks until reset via `msg.context = "reset"` (requires `msg.payload = true` if `resetRequireTrue = true`) or 
automatically if `resetOnComplete = true`. Non-`true` payloads are ignored with no output. 

Duration configurable via editor or `msg.context = "duration"` with `msg.units` (`"milliseconds"`, `"seconds"`, `"minutes"`). 

Tracks `triggerCount` (number of triggers) and displays in status. 

Outputs new `{ payload: boolean }` messages for every trigger (`true` then `false`), reset, or locked input. 

### Status
- Green (dot): Trigger or duration update (e.g., `triggers: 1, out: true`, `duration: 1000 ms`).
- Blue (dot): Reset (e.g., `triggers: 1, reset`).
- Blue (ring): Initial or auto-reset (e.g., `triggers: 0, unlocked`).
- Red (ring): Locked or error (e.g., `triggers: 1, locked`, `invalid duration`, `invalid reset payload`).
- Yellow (ring): Ignored non-`true` payload or unknown context (e.g., `ignored: non-true`, `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>