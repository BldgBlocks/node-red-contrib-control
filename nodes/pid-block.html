<!-- UI Template Section -->
<script type="text/html" data-template-name="pid-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-kp" title="Proportional gain (number)"><i class="fa fa-sliders"></i> Kp</label>
        <input type="text" id="node-input-kp" placeholder="0" step="any">
        <input type="hidden" id="node-input-kpType">
    </div>
    <div class="form-row">
        <label for="node-input-ki" title="Integral gain (number)"><i class="fa fa-sliders"></i> Ki</label>
        <input type="text" id="node-input-ki" placeholder="0" step="any">
        <input type="hidden" id="node-input-kiType">
    </div>
    <div class="form-row">
        <label for="node-input-kd" title="Derivative gain (number)"><i class="fa fa-sliders"></i> Kd</label>
        <input type="text" id="node-input-kd" placeholder="0" step="any">
        <input type="hidden" id="node-input-kdType">
    </div>
    <div class="form-row">
        <label for="node-input-setpoint" title="Target setpoint (number)"><i class="fa fa-crosshairs"></i> Setpoint</label>
        <input type="text" id="node-input-setpoint" placeholder="0" step="any">
        <input type="hidden" id="node-input-setpointType">
    </div>
    <div class="form-row">
        <label for="node-input-deadband" title="Deadband range around setpoint (non-negative number)"><i class="fa fa-arrows-h"></i> Deadband</label>
        <input type="text" id="node-input-deadband" placeholder="0" step="any" min="0">
        <input type="hidden" id="node-input-deadbandType">
    </div>
    <div class="form-row">
        <label for="node-input-dbBehavior" title="Deadband behavior: ReturnToZero or HoldLastResult"><i class="fa fa-cog"></i> Deadband Behavior</label>
        <select id="node-input-dbBehavior">
            <option value="ReturnToZero">ReturnToZero</option>
            <option value="HoldLastResult">HoldLastResult</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-outMin" title="Minimum output limit (number, less than outMax, leave empty for no limit)"><i class="fa fa-arrow-down"></i> Out Min</label>
        <input type="text" id="node-input-outMin" placeholder="No min" step="any">
        <input type="hidden" id="node-input-outMinType">
    </div>
    <div class="form-row">
        <label for="node-input-outMax" title="Maximum output limit (number, greater than outMin, leave empty for no limit)"><i class="fa fa-arrow-up"></i> Out Max</label>
        <input type="text" id="node-input-outMax" placeholder="No max" step="any">
        <input type="hidden" id="node-input-outMaxType">
    </div>
    <div class="form-row">
        <label for="node-input-maxChange" title="Maximum output change per cycle (non-negative number)"><i class="fa fa-exchange"></i> Max Change</label>
        <input type="text" id="node-input-maxChange" placeholder="0" step="any" min="0">
        <input type="hidden" id="node-input-maxChangeType">
    </div>
    <div class="form-row">
        <label for="node-input-directAction" title="Direct (true) or reverse (false) action"><i class="fa fa-exchange"></i> Direct Action</label>
        <input type="checkbox" id="node-input-directAction" style="width: auto; vertical-align: middle;">
    </div>
    <div class="form-row">
        <label for="node-input-run" title="Enable (true) or disable (false) PID calculation"><i class="fa fa-play"></i> Run</label>
        <input type="text" id="node-input-run" style="width: auto; vertical-align: middle;" checked>
        <input type="hidden" id="node-input-runType">
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("pid-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            kp: { value: 0, required: true },
            kpType: { value: "num" },
            ki: { value: 0, required: true },
            kiType: { value: "num" },
            kd: { value: 0, required: true },
            kdType: { value: "num" },
            setpoint: { value: 0, required: true },
            setpointType: { value: "num" },
            deadband: { value: 0, required: true },
            deadbandType: { value: "num" },
            dbBehavior: { value: "ReturnToZero" },
            outMin: { value: null },
            outMinType: { value: "num" },
            outMax: { value: null },
            outMaxType: { value: "num" },
            maxChange: { value: 0, required: true },
            maxChangeType: { value: "num" },
            directAction: { value: false },
            run: { value: true },
            runType: { value: "bool" }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output"],
        icon: "font-awesome/fa-cogs",
        paletteLabel: "pid",
        label: function() {
            return this.name || "pid";
        },
        oneditprepare: function() {
            const node = this;

            try {
                // Initialize typed inputs
                $("#node-input-kp").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-kpType"
                }).typedInput("type", node.kpType || "num").typedInput("value", node.kp);

                $("#node-input-ki").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-kiType"
                }).typedInput("type", node.kiType || "num").typedInput("value", node.ki);

                $("#node-input-kd").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-kdType"
                }).typedInput("type", node.kdType || "num").typedInput("value", node.kd);

                $("#node-input-setpoint").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-setpointType"
                }).typedInput("type", node.setpointType || "num").typedInput("value", node.setpoint);

                $("#node-input-deadband").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-deadbandType"
                }).typedInput("type", node.deadbandType || "num").typedInput("value", node.deadband);

                $("#node-input-outMin").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-outMinType"
                }).typedInput("type", node.outMinType || "num").typedInput("value", node.outMin);

                $("#node-input-outMax").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-outMaxType"
                }).typedInput("type", node.outMaxType || "num").typedInput("value", node.outMax);

                $("#node-input-maxChange").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-maxChangeType"
                }).typedInput("type", node.maxChangeType || "num").typedInput("value", node.maxChange);

                $("#node-input-run").typedInput({
                    default: "bool",
                    types: ["bool", "msg", "flow", "global"],
                    typeField: "#node-input-runType"
                }).typedInput("type", node.runType || "bool").typedInput("value", node.run);

            } catch (err) {
                console.error("Error in oneditprepare:", err);
            }

        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="pid-block">
Implements a PID controller with deadband, output limits, and tuning.

### Inputs
: context (string) : Configures settings (`"setpoint"`, `"kp"`, `"ki"`, `"kd"`, `"deadband"`, `"dbBehavior"`, `"outMin"`, `"outMax"`, `"maxChange"`, `"directAction"`, `"run"`, `"reset"`, `"tune"`). Unmatched values trigger error.
: payload (number | boolean | string) : Number for input/setpoint/kp/ki/kd/deadband/outMin/outMax/maxChange/tune kp, boolean for run/directAction/reset, string for dbBehavior (`"ReturnToZero"`, `"HoldLastResult"`).

### Outputs
: payload (number) : PID control output.
: diagnostics (object) : `{ pGain, intGain, dGain, error, errorSum }`.
: tuneResult (object) : `{ Kp, Ki, Kd, Ku, Tu }` when tuning completes.

### Properties
: kp (number) : Proportional gain. Default: 0.
: ki (number) : Integral gain. Default: 0.
: kd (number) : Derivative gain. Default: 0.
: setpoint (number) : Target setpoint. Default: 0.
: deadband (number) : Deadband range around setpoint (non-negative). Default: 0.
: dbBehavior (string) : Deadband behavior (`"ReturnToZero"`, `"HoldLastResult"`). Default: `"ReturnToZero"`.
: outMin (number | null) : Minimum output limit (less than outMax). Default: null.
: outMax (number | null) : Maximum output limit (greater than outMin). Default: null.
: maxChange (number) : Maximum output change per cycle (non-negative). Default: 0.
: directAction (boolean) : Direct (true) or reverse (false) action. Default: false.
: run (boolean) : Enable (true) or disable (false) PID calculation. Default: true.

### Details
Calculates PID control output based on numeric `msg.payload`, setpoint, and gains (`kp`, `ki`, `kd`). 

Supports deadband, output limits, rate of change limit, direct/reverse action, integral clamping, and Ziegler-Nichols tuning. 

Outputs `{ payload: number, diagnostics: object }` when output changes, or `{ tuneResult: object }` on tuning completion. 

Ziegler-Nichols tuning sets `kp = 0.6*Ku`, `ki = 2*kp/Tu`, `kd = kp*Tu/8` after detecting oscillations. Outputs only on change.

### Error Handling
- Missing `msg`: No output, red status (`invalid message`).
- Missing `msg.payload` for config: No output, red status (`missing payload for X`).
- Invalid context (non-string): No output, red status (`invalid context`).
- Invalid setpoint/kp/ki/kd/deadband/outMin/outMax/maxChange/tune kp (non-numeric, non-finite): No output, red status (`invalid X`).
- Invalid deadband/maxChange (negative): No output, red status (`invalid X`).
- Invalid run/directAction/reset (non-boolean, reset not true): No output, red status (`invalid X`).
- Invalid dbBehavior (not `"ReturnToZero"`, `"HoldLastResult"`): No output, red status (`invalid dbBehavior`).
- Invalid output range (outMax <= outMin): No output, red status (`invalid output range`).
- Invalid input (non-numeric, non-finite): No output, red status (`invalid input`).
- Unknown `msg.context`: No output, yellow status (`unknown context`), errors with message.
- Invalid config at startup: Red status (`invalid config` or specific), resets to defaults.

### Status
- Green (dot): Configuration, reset, or tuning
- Blue (dot): Output change
- Blue (ring): Output unchanged
- Red (ring): Errors
- Yellow (ring): Unknown context

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>