<!-- UI Template Section -->
<script type="text/html" data-template-name="ratelimitthreshold-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-mode" title="Processing mode"><i class="fa fa-cog"></i> Mode</label>
        <select id="node-input-mode">
            <option value="rate-limit">Rate Limit</option>
            <option value="threshold">Threshold</option>
            <option value="full-value">Full Value</option>
        </select>
    </div>
    <div class="form-row rate-limit-field">
        <label for="node-input-rate" title="Rate of change (units per second)"><i class="fa fa-tachometer"></i> Rate (units/s)</label>
        <input type="number" id="node-input-rate" placeholder="1" min="0.01" step="0.01">
    </div>
    <div class="form-row rate-limit-field">
        <label for="node-input-interval" title="Update interval (ms)"><i class="fa fa-clock-o"></i> Interval (ms)</label>
        <input type="number" id="node-input-interval" placeholder="100" min="10" step="10">
    </div>
    <div class="form-row threshold-field">
        <label for="node-input-threshold" title="Threshold for output (units)"><i class="fa fa-filter"></i> Threshold (units)</label>
        <input type="number" id="node-input-threshold" placeholder="5" min="0" step="0.01">
    </div>
</script>

<!-- JavaScript Section -->
<script type="text/javascript">
    RED.nodes.registerType("ratelimitthreshold-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "rate limit" },
            mode: { value: "rate-limit", required: true },
            rate: { value: 1, required: false, validate: function (v) { return !v || Number(v) > 0; } },
            interval: { value: 100, required: false, validate: function (v) { return !v || (Number.isInteger(+v) && +v >= 10); } },
            threshold: { value: 5, required: false, validate: function (v) { return !v || Number(v) >= 0; } }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["value"],
        outputLabels: ["processed value"],
        icon: "font-awesome/fa-wrench",
        paletteLabel: "rate limit",
        label: function () {
            return this.name || `${this.mode} (${this.mode === "rate-limit" ? this.rate + "/s" : this.mode === "threshold" ? this.threshold : "full"})`;
        },
        oneditprepare: function () {
            function updateFieldVisibility() {
                const mode = $("#node-input-mode").val();
                $(".rate-limit-field").toggle(mode === "rate-limit");
                $(".threshold-field").toggle(mode === "threshold");
            }
            $("#node-input-mode").on("change", updateFieldVisibility);
            updateFieldVisibility();
        }
    });
</script>

<!-- Help Section -->
<script type="text/markdown" data-help-name="ratelimitthreshold-block">
# RateLimitThreshold Block Node

Processes a numeric input value based on a selected mode: rate limit, threshold, or full value.

## Inputs
- **payload** (number): The input value to process.

## Outputs
- **payload** (number): The processed value, depending on the mode.

## Details
The RateLimitThreshold Block node processes numeric inputs in one of three modes, selected via the editor:

- **Rate Limit**: Limits the rate of change, adjusting the output toward the input at a configurable rate (units per second) with updates at a specified interval (milliseconds). Ideal for smoothing transitions, like adjusting setpoints.
- **Threshold**: Outputs the input only when it differs from the last output by more than a configurable threshold. Useful for filtering small changes, like ignoring minor sensor fluctuations.
- **Full Value**: Passes the input value unchanged (bypass mode).

The node stores state (current value, last output) in context for persistence. The status shows the mode, current value, and mode-specific details (target, rate, threshold, or difference).

## Error Handling
- Non-numeric inputs show a red "Invalid input" status and no output.

Status shows:
- Green for new input/output (`Mode: X, Value: Y.YY, ...`).
- Blue for updates/no output (`Mode: X, Value: Y.YY, ...`).
- Red for errors (`Invalid input: Y.YY`).

### Mode-Specific Status
- **Rate Limit**: `Mode: rate-limit, Value: Y.YY, Target: Z.ZZ, Rate: W.WW/s`
- **Threshold**: `Mode: threshold, Last: Y.YY, Threshold: Z.ZZ, Diff: W.WW` (if no output)
- **Full Value**: `Mode: full-value, Value: Y.YY`
</script>