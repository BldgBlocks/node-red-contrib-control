<!-- UI Template Section: Defines the edit dialog for the Saw Tooth Wave Block node -->
<script type="text/html" data-template-name="saw-tooth-wave-block">
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-lowerLimit" title="Minimum output value"><i class="fa fa-arrow-down"></i> Lower Limit</label>
        <input type="number" id="node-input-lowerLimit" placeholder="0" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-upperLimit" title="Maximum output value"><i class="fa fa-arrow-up"></i> Upper Limit</label>
        <input type="number" id="node-input-upperLimit" placeholder="100" step="any">
    </div>
    <div class="form-row">
        <label for="node-input-period" title="Wave period (positive number, e.g., 10)"><i class="fa fa-clock-o"></i> Period</label>
        <input type="number" id="node-input-period" placeholder="10" min="0.001" step="any">
        <select id="node-input-periodUnits">
            <option value="milliseconds">Milliseconds</option>
            <option value="seconds">Seconds</option>
            <option value="minutes">Minutes</option>
        </select>
    </div>
</script>

<!-- JavaScript Section: Registers the node and handles editor logic -->
<script type="text/javascript">
    RED.nodes.registerType("saw-tooth-wave-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "saw tooth wave" },
            lowerLimit: { value: 0, required: true, validate: RED.validators.number() },
            upperLimit: { value: 100, required: true, validate: RED.validators.number() },
            period: {
                value: 10,
                required: true,
                validate: function(v) { return !isNaN(parseFloat(v)) && parseFloat(v) > 0; }
            },
            periodUnits: { value: "seconds" }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output"],
        icon: "font-awesome/fa-wrench",
        paletteLabel: "saw tooth wave",
        label: function () {
            return this.name || "saw tooth wave";
        },
        oneditprepare: function () {
            const id = this.id;
            // Initialize with pending client-side values
            $("#node-input-name").val(this.name || "saw tooth wave");
            $("#node-input-lowerLimit").val(this.lowerLimit || 0);
            $("#node-input-upperLimit").val(this.upperLimit || 100);
            $("#node-input-period").val(this.period || 10);
            $("#node-input-periodUnits").val(this.periodUnits || "seconds");

            // Fetch server data only for deployed nodes
            $.getJSON(`/saw-tooth-wave-block/${id}?t=${Date.now()}`, function (data) {
                // Only update if node is deployed and data differs
                if (data && (
                    data.name !== this.name ||
                    data.lowerLimit !== this.lowerLimit ||
                    data.upperLimit !== this.upperLimit ||
                    data.period !== this.period ||
                    data.periodUnits !== this.periodUnits
                )) {
                    $("#node-input-name").val(data.name || this.name || "saw tooth wave");
                    $("#node-input-lowerLimit").val(data.lowerLimit || this.lowerLimit || 0);
                    $("#node-input-upperLimit").val(data.upperLimit || this.upperLimit || 100);
                    $("#node-input-period").val(data.period || this.period || 10);
                    $("#node-input-periodUnits").val(data.periodUnits || this.periodUnits || "seconds");
                }
            }.bind(this)).fail(function () {
                // No server data; rely on this properties (already set)
            });
        },
        oneditsave: function () {
            // Standard config properties are automatically saved by Node-RED
        }
    });
</script>

<!-- Help Section: Provides documentation for the Saw Tooth Wave Block node -->
<script type="text/markdown" data-help-name="saw-tooth-wave-block">
Generates a sawtooth wave output scaled to a configurable range.

### Inputs
- **context** <span class="property-type">string</span>
  Sets configuration ("lowerLimit", "upperLimit", "period").
- **payload** <span class="property-type">number</span>
  Config value for lowerLimit, upperLimit, or period.
- **units** <span class="property-type">string, optional</span>
  Units for period configuration ("milliseconds", "seconds", "minutes").

### Outputs
- **payload** <span class="property-type">number</span>
  Sawtooth wave value scaled between lowerLimit and upperLimit.

### Details
The Saw Tooth Wave Block generates a sawtooth wave output based on time, scaled between `lowerLimit` and `upperLimit` over a `period`. It produces a linear ramp from `lowerLimit` to `upperLimit` followed by a sharp drop, tracking phase (0 to 1) for continuity.

The node name, limits, period, and period units are configurable in the editor or via `msg.context` with a numeric `msg.payload` and optional `msg.units`. The node ensures `upperLimit ≥ lowerLimit` by adjusting the other value if needed. If `period ≤ 0`, it outputs `lowerLimit`.

Outputs are new messages with `msg.payload` set to the wave value, generated for each input trigger. Editor changes require redeployment; message-based updates apply immediately and are reflected in the editor.

### Examples
- **Wave Output**: Config `lowerLimit=0`, `upperLimit=100`, `period=10` seconds, input `{}`, output `{ payload: 50 }` at 5 seconds.
- **Set Limit**: Input `{ context: "upperLimit", payload: 200 }`, no output, sets `upperLimit=200`.
- **Set Period**: Input `{ context: "period", payload: 1, units: "minutes" }`, no output, sets `period=60000ms`.

### Error Handling
- Missing `msg.payload` for config: Shows "missing payload" (red), no output.
- Invalid lowerLimit/upperLimit/period (non-numeric): Shows "invalid lowerLimit", "invalid upperLimit", or "invalid period" (red), no output.
- Invalid period (non-positive): Shows "invalid period" (red), no output.
- Unknown `msg.context`: Shows "unknown context" (yellow), no output.

Status shows green for config (e.g., `lower: 0.00`, `period: 10000.00`), blue for output (e.g., `out: 50.00, phase: 0.50`), red or yellow for errors.

### References
- [Node-RED Documentation](https://nodered.org/docs/) - official Node-RED documentation
- [GitHub Repository](https://github.com/your-repo/node-red-contrib-buildingblocks-control) - source code and additional help
</script>