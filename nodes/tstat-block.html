<script type="text/html" data-template-name="tstat-block">`
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-algorithm" title="Algorithm: single setpoint with diff, split setpoints, or specified setpoints"><i class="fa fa-cog"></i> Algorithm</label>
        <input type="text" id="node-input-algorithm" placeholder="single">
        <input type="hidden" id="node-input-algorithmType">
    </div>
    <div class="form-row single-setpoint">
        <label for="node-input-setpoint" title="Target temperature setpoint (number from num, msg, flow, or global)"><i class="fa fa-crosshairs"></i> Setpoint</label>
        <input type="text" id="node-input-setpoint" placeholder="70">
        <input type="hidden" id="node-input-setpointType">
    </div>
    <div class="form-row split-setpoint" style="display: none;">
        <label for="node-input-heatingSetpoint" title="Target temperature for heating (number from num, msg, flow, or global)"><i class="fa fa-crosshairs"></i> Heating Setpoint</label>
        <input type="text" id="node-input-heatingSetpoint" placeholder="68">
        <input type="hidden" id="node-input-heatingSetpointType">
    </div>
    <div class="form-row split-setpoint" style="display: none;">
        <label for="node-input-coolingSetpoint" title="Target temperature for cooling (number from num, msg, flow, or global)"><i class="fa fa-crosshairs"></i> Cooling Setpoint</label>
        <input type="text" id="node-input-coolingSetpoint" placeholder="74">
        <input type="hidden" id="node-input-coolingSetpointType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-coolingOn" title="Temperature to turn cooling on (number from num, msg, flow, or global)"><i class="fa fa-snowflake-o"></i> Cooling On</label>
        <input type="text" id="node-input-coolingOn" placeholder="74">
        <input type="hidden" id="node-input-coolingOnType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-coolingOff" title="Temperature to turn cooling off (number from num, msg, flow, or global)"><i class="fa fa-snowflake-o"></i> Cooling Off</label>
        <input type="text" id="node-input-coolingOff" placeholder="72">
        <input type="hidden" id="node-input-coolingOffType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-heatingOff" title="Temperature to turn heating off (number from num, msg, flow, or global)"><i class="fa fa-fire"></i> Heating Off</label>
        <input type="text" id="node-input-heatingOff" placeholder="68">
        <input type="hidden" id="node-input-heatingOffType">
    </div>
    <div class="form-row specified-setpoint" style="display: none;">
        <label for="node-input-heatingOn" title="Temperature to turn heating on (number from num, msg, flow, or global)"><i class="fa fa-fire"></i> Heating On</label>
        <input type="text" id="node-input-heatingOn" placeholder="66">
        <input type="hidden" id="node-input-heatingOnType">
    </div>
    <div class="form-row single-setpoint">
        <label for="node-input-diff" title="Differential for hysteresis (positive number, used in single algorithm)"><i class="fa fa-arrows-v"></i> Differential</label>
        <input type="text" id="node-input-diff" placeholder="2">
        <input type="hidden" id="node-input-diffType">
    </div>
    <div class="form-row">
        <label for="node-input-anticipator" title="Temperature offset to stop heating/cooling early (non-negative number from num, msg, flow, or global)"><i class="fa fa-tachometer"></i> Anticipator</label>
        <input type="text" id="node-input-anticipator" placeholder="0.5">
        <input type="hidden" id="node-input-anticipatorType">
    </div>
    <div class="form-row">
        <label for="node-input-ignoreAnticipatorCycles" title="Number of cycles to ignore anticipator after mode change (non-negative integer from num, msg, flow, or global)"><i class="fa fa-repeat"></i> Ignore Anticipator Cycles</label>
        <input type="text" id="node-input-ignoreAnticipatorCycles" placeholder="1">
        <input type="hidden" id="node-input-ignoreAnticipatorCyclesType">
    </div>
    <div class="form-row">
        <label for="node-input-isHeating" title="Heating mode (true) or cooling mode (false)"><i class="fa fa-fire"></i> Heating Mode</label>
        <input type="text" id="node-input-isHeating" style="width: auto; vertical-align: middle;">
        <input type="hidden" id="node-input-isHeatingType">
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("tstat-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            algorithm: { value: "single" },
            algorithmType: { value: "dropdown" },
            setpoint: { value: "70" },
            setpointType: { value: "num" },
            heatingSetpoint: { value: "68" },
            heatingSetpointType: { value: "num" },
            coolingSetpoint: { value: "74" },
            coolingSetpointType: { value: "num" },
            coolingOn: { value: "74" },
            coolingOnType: { value: "num" },
            coolingOff: { value: "72" },
            coolingOffType: { value: "num" },
            heatingOff: { value: "68" },
            heatingOffType: { value: "num" },
            heatingOn: { value: "66" },
            heatingOnType: { value: "num" },
            diff: { value: "2" },
            diffType: { value: "num" },
            anticipator: { value: "0.5" },
            anticipatorType: { value: "num" },
            ignoreAnticipatorCycles: { value: "1" },
            ignoreAnticipatorCyclesType: { value: "num" },
            isHeating: { value: false },
            isHeatingType: { value: "bool" }
        },
        inputs: 1,
        outputs: 3,
        outputLabels: ["isHeating", "above", "below"],
        inputLabels: ["input"],
        icon: "font-awesome/fa-thermometer-half",
        paletteLabel: "tstat",
        label: function() {
            return this.name || "tstat";
        },
        oneditprepare: function() {
            const node = this;
            try {
                const $algorithm = $("#node-input-algorithm");
                const $singleFields = $(".single-setpoint");
                const $splitFields = $(".split-setpoint");
                const $specifiedFields = $(".specified-setpoint");
                
                $("#node-input-algorithm").typedInput({
                    default: "dropdown",
                    types: [{
                        value: "dropdown",
                        options: [
                            { value: "single", label: "Single"},
                            { value: "split", label: "Split"},
                            { value: "specified", label: "Specified"},
                        ]
                    }, "msg", "flow", "global"],
                    typeField: "#node-input-algorithmType"
                }).typedInput("type", node.algorithmType).typedInput("value", node.algorithm);

                $("#node-input-setpoint").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-setpointType"
                }).typedInput("type", node.setpointType || "num").typedInput("value", node.setpoint);

                $("#node-input-heatingSetpoint").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-heatingSetpointType"
                }).typedInput("type", node.heatingSetpointType || "num").typedInput("value", node.heatingSetpoint);

                $("#node-input-coolingSetpoint").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-coolingSetpointType"
                }).typedInput("type", node.coolingSetpointType || "num").typedInput("value", node.coolingSetpoint);

                $("#node-input-coolingOn").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-coolingOnType"
                }).typedInput("type", node.coolingOnType || "num").typedInput("value", node.coolingOn);

                $("#node-input-coolingOff").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-coolingOffType"
                }).typedInput("type", node.coolingOffType || "num").typedInput("value", node.coolingOff);

                $("#node-input-heatingOff").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-heatingOffType"
                }).typedInput("type", node.heatingOffType || "num").typedInput("value", node.heatingOff);

                $("#node-input-heatingOn").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-heatingOnType"
                }).typedInput("type", node.heatingOnType || "num").typedInput("value", node.heatingOn);

                $("#node-input-diff").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-diffType"
                }).typedInput("type", node.diffType || "num").typedInput("value", node.diff);
                
                $("#node-input-anticipator").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-anticipatorType"
                }).typedInput("type", node.anticipatorType || "num").typedInput("value", node.anticipator);

                $("#node-input-ignoreAnticipatorCycles").typedInput({
                    default: "num",
                    types: ["num", "msg", "flow", "global"],
                    typeField: "#node-input-ignoreAnticipatorCyclesType"
                }).typedInput("type", node.ignoreAnticipatorCyclesType || "num").typedInput("value", node.ignoreAnticipatorCycles);

                $("#node-input-isHeating").typedInput({
                    default: "bool",
                    types: ["bool", "msg", "flow", "global"],
                    typeField: "#node-input-isHeatingType"
                }).typedInput("type", node.isHeatingType || "bool").typedInput("value", node.isHeating);

                function toggleFields() {
                    const algorithm = $algorithm.val();
                    if (algorithm === "single") {
                        $singleFields.show();
                        $splitFields.hide();
                        $specifiedFields.hide();
                    } else if (algorithm === "split") {
                        $singleFields.hide();
                        $splitFields.show();
                        $specifiedFields.hide();
                    } else {
                        $singleFields.hide();
                        $splitFields.hide();
                        $specifiedFields.show();
                    }
                }

                $algorithm.on("change", function() {
                    toggleFields();
                });

                toggleFields();

            } catch (err) {
                console.error("Error in tstat-block oneditprepare:", err.message, err.stack);
            }
        }
    });
</script>

<script type="text/markdown" data-help-name="tstat-block">
Thermostat controller for heating/cooling with single, split, or specified setpoint operation, hysteresis, and anticipation to prevent or allow overshoot for testing.

### Inputs
: context (string) : Configures node (`"algorithm"`, `"setpoint"`, `"heatingSetpoint"`, `"coolingSetpoint"`, `"coolingOn"`, `"coolingOff"`, `"heatingOff"`, `"heatingOn"`, `"diff"`, `"anticipator"`, `"ignoreAnticipatorCycles"`, `"isHeating"`, `"status"`).
: payload (number | boolean | string) : Number for temperature or config values, boolean for `isHeating`, string for `algorithm` (`"single"`, `"split"`, `"specified"`).

### Outputs
All output messages include a `msg.status` object containing runtime information
: isHeating (boolean) : `true` for heating mode, `false` for cooling mode. Includes `msg.context = "isHeating"`.
: above (boolean) : `true` if input exceeds cooling on threshold.
: below (boolean) : `true` if input is below heating on threshold.
: status (object) : Contains detailed runtime information including:
  - `algorithm`: Current algorithm in use
  - `input`: Current temperature input value
  - `isHeating`: Current heating mode
  - `above/below`: Current output states
  - Algorithm-specific setpoints and values
  - `modeChanged`: If mode recently changed
  - `cyclesSinceModeChange`: Count since last mode change
  - `effectiveAnticipator`: Current anticipator value after mode change adjustments

### Status Monitoring
All outputs include comprehensive status information in `msg.status`. Example:
```json
{
  "status": {
    "algorithm": "single",
    "input": 68.5,
    "isHeating": true,
    "above": false,
    "below": true,
    "setpoint": 70,
    "diff": 2,
    "anticipator": 0.5,
    "modeChanged": false,
    "cyclesSinceModeChange": 3,
    "effectiveAnticipator": 0.5
  }
}
```

### Algorithms
- **Single Setpoint**:
  - Uses `setpoint`, `diff`, and `anticipator`.
  - Sets `above` if `input > setpoint + diff/2`, clears when `input < setpoint + anticipator`.
  - Sets `below` if `input < setpoint - diff/2`, clears when `input > setpoint - anticipator`.
  - For positive `anticipator`, stops early to prevent overshoot. For negative `anticipator` (testing only), delays turn-off to overshoot setpoint.
  - Example: `setpoint=70`, `diff=2`, `anticipator=-0.5`, `above` if `input > 71`, clears at `< 69.5` (overshoots); `below` if `input < 69`, clears at `> 70.5` (overshoots).

- **Split Setpoint**:
  - Uses `heatingSetpoint`, `coolingSetpoint`, `diff`, and `anticipator`.
  - For `isHeating = true`:
    - Sets `below` if `input < heatingSetpoint - diff/2`, clears when `input > heatingSetpoint - anticipator`.
    - `above` is `false`.
  - For `isHeating = false`:
    - Sets `above` if `input > coolingSetpoint + diff/2`, clears when `input < coolingSetpoint + anticipator`.
    - `below` is `false`.
  - Ensures `heatingSetpoint < coolingSetpoint`.
  - For negative `anticipator`, delays turn-off (e.g., heating off above `heatingSetpoint`).
  - Example: `heatingSetpoint=68`, `coolingSetpoint=74`, `diff=2`, `anticipator=-0.5`, heating mode sets `below` if `input < 67`, clears at `> 68.5`; cooling mode sets `above` if `input > 75`, clears at `< 73.5`.

- **Specified Setpoint**:
  - Uses `coolingOn`, `coolingOff`, `heatingOff`, `heatingOn`, and `anticipator`.
  - For `isHeating = false`:
    - Sets `above` if `input > coolingOn`, clears when `input < coolingOff + anticipator`.
    - `below` is `false`.
  - For `isHeating = true`:
    - Sets `below` if `input < heatingOn`, clears when `input > heatingOff - anticipator`.
    - `above` is `false`.
  - Validates `coolingOn >= coolingOff >= heatingOff >= heatingOn`.
  - For negative `anticipator`, delays turn-off (e.g., heating off above `heatingOff`).
  - Example: `coolingOn=74`, `coolingOff=72`, `heatingOff=68`, `heatingOn=66`, `anticipator=-0.5`, cooling mode sets `above` if `input > 74`, clears at `< 71.5`; heating mode sets `below` if `input < 66`, clears at `> 68.5`.

### Details
Compares a numeric temperature input (`msg.payload`) against setpoints to control heating or cooling. 

The `differential` (`diff`) applies to the `single` and `split` setpoint algorithms, providing hysteresis. 

The `anticipator` adjusts turn-off points: positive values stop early to prevent overshoot (subtracts for heating, adds for cooling); 
negative values (allowed for testing, >= -2) delay turn-off to overshoot setpoint. 

The `isHeating` flag (typically from a changeover node) sets output 1 and selects the active setpoint(s).

The `ignoreAnticipatorCycles` setting allows ignoring the anticipator for a specified number of cycles after a mode change to reduce short-cycling. 

All numeric inputs (`setpoint`, `heatingSetpoint`, `coolingSetpoint`, `coolingOn`, `coolingOff`, `heatingOff`, `heatingOn`, `diff`, `anticipator`, 
`ignoreAnticipatorCycles`) support `num`, `msg`, `flow`, or `global` types via `typedInput`.

### Status
- Green (dot): Configuration updates (e.g., `setpoint: 70.0`, `anticipator: 0.5`, `isHeating: true`).
- Blue (dot): Outputs when state changes (e.g., `in: 65.00, out: heating, above: false, below: true`).
- Blue (ring): Outputs when state unchanged (e.g., `in: 66.00, out: heating, above: false, below: true`).
- Red (ring): Errors (e.g., `missing input`, `invalid coolingOff`, `invalid diff, using 2`).
- Yellow (ring): Warnings (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>