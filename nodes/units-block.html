<script type="text/html" data-template-name="units-block">
    <div class="form-row">
        <label for="node-input-unit" title="Unit to append to msg.units"><i class="fa fa-tag"></i> Unit</label>
        <select id="node-input-unit">
            <optgroup label="Temperature">
                <option value="°C">°C (Celsius)</option>
                <option value="°F">°F (Fahrenheit)</option>
                <option value="K">K (Kelvin)</option>
            </optgroup>
            <optgroup label="Humidity">
                <option value="%RH">%RH (Relative Humidity)</option>
                <option value="%">% (Percent)</option>
            </optgroup>
            <optgroup label="Pressure">
                <option value="Pa">Pa (Pascal)</option>
                <option value="kPa">kPa (Kilopascal)</option>
                <option value="bar">bar</option>
                <option value="mbar">mbar (Millibar)</option>
                <option value="psi">psi</option>
                <option value="atm">atm (Atmosphere)</option>
                <option value="inH₂O">inH₂O (Inches of Water)</option>
                <option value="mmH₂O">mmH₂O (Millimeters of Water)</option>
            </optgroup>
            <optgroup label="Airflow">
                <option value="CFM">CFM (Cubic Feet per Minute)</option>
                <option value="m³/h">m³/h (Cubic Meters per Hour)</option>
                <option value="L/s">L/s (Liters per Second)</option>
            </optgroup>
            <optgroup label="Electrical">
                <option value="V">V (Volt)</option>
                <option value="mV">mV (Millivolt)</option>
                <option value="A">A (Ampere)</option>
                <option value="mA">mA (Milliampere)</option>
                <option value="W">W (Watt)</option>
                <option value="Ω">Ω (Ohm)</option>
            </optgroup>
            <optgroup label="Length">
                <option value="m">m (Meter)</option>
                <option value="cm">cm (Centimeter)</option>
                <option value="mm">mm (Millimeter)</option>
                <option value="km">km (Kilometer)</option>
                <option value="ft">ft (Foot)</option>
                <option value="in">in (Inch)</option>
            </optgroup>
            <optgroup label="Mass">
                <option value="kg">kg (Kilogram)</option>
                <option value="g">g (Gram)</option>
                <option value="lb">lb (Pound)</option>
            </optgroup>
            <optgroup label="Time">
                <option value="s">s (Second)</option>
                <option value="min">min (Minute)</option>
                <option value="h">h (Hour)</option>
            </optgroup>
            <optgroup label="Volume">
                <option value="L">L (Liter)</option>
                <option value="mL">mL (Milliliter)</option>
                <option value="gal">gal (Gallon)</option>
            </optgroup>
            <optgroup label="Light">
                <option value="lx">lx (Lux)</option>
                <option value="cd">cd (Candela)</option>
            </optgroup>
            <optgroup label="Magnetic">
                <option value="B">B (Bel)</option>
                <option value="T">T (Tesla)</option>
            </optgroup>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name" title="Display name shown on the canvas"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row node-changed-values" style="display: none;">
        <label><i class="fa fa-info-circle"></i> Changed Runtime Values</label>
        <div style="margin-left: 30px;">
            <p><strong>Unit:</strong> <span id="node-changed-unit">°F</span></p>
        </div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType("units-block", {
        category: "control",
        color: "#301934",
        defaults: {
            name: { value: "" },
            unit: { value: "°F", required: true }
        },
        inputs: 1,
        outputs: 1,
        inputLabels: ["input"],
        outputLabels: ["output with units"],
        icon: "font-awesome/fa-tag",
        paletteLabel: "units",
        label: function() {
            return this.name ? `Units ${this.name}` : `units ${this.unit}`;
        },
        oneditprepare: function() {
            // Initialize inputs
            $("#node-input-name").val(this.name || "");
            $("#node-input-unit").val(this.unit || "°F");

            // Validate name input
            $("#node-input-name").on("input", function() {
                const val = $(this).val();
                if (!val || val.trim().length === 0) {
                    $(this).addClass("input-error");
                } else {
                    $(this).removeClass("input-error");
                }
            });

            // Validate unit input
            $("#node-input-unit").on("change", function() {
                const val = $(this).val();
                const validUnits = ["°C", "°F", "K", "%RH", "Pa", "kPa", "bar", "mbar", "psi", "atm", "inH₂O", "mmH₂O", "CFM", "m³/h", "L/s", "V", "mV", "A", "mA", "W", "Ω", "%", "m", "cm", "mm", "km", "ft", "in", "kg", "g", "lb", "s", "min", "h", "L", "mL", "gal", "lx", "cd", "B", "T"];
                if (!validUnits.includes(val)) {
                    $(this).addClass("input-error");
                } else {
                    $(this).removeClass("input-error");
                }
            });

            // Fetch runtime values for deployed nodes
            const id = this.id;
            $.getJSON(`/units-block/${id}?t=${Date.now()}`, function(data) {
                if (data && (data.unit !== this.unit)) {
                    $("#node-changed-unit").text(data.unit || "°F");
                    $(".node-changed-values").show();
                } else {
                    $(".node-changed-values").hide();
                }
            }.bind(this)).fail(function() {
                $(".node-changed-values").hide();
            });
        },
        oneditsave: function() {
            // Standard config properties are automatically saved
        },
        oneditvalidate: function() {
            const name = $("#node-input-name").val();
            const unit = $("#node-input-unit").val();
            const validUnits = ["°C", "°F", "K", "%RH", "Pa", "kPa", "bar", "mbar", "psi", "atm", "inH₂O", "mmH₂O", "CFM", "m³/h", "L/s", "V", "mV", "A", "mA", "W", "Ω", "%", "m", "cm", "mm", "km", "ft", "in", "kg", "g", "lb", "s", "min", "h", "L", "mL", "gal", "lx", "cd", "B", "T"];
            if (!name || name.trim().length === 0) {
                $("#node-input-name").addClass("input-error");
                return false;
            }
            if (!validUnits.includes(unit)) {
                $("#node-input-unit").addClass("input-error");
                return false;
            }
            return true;
        }
    });
</script>

<script type="text/markdown" data-help-name="units-block">
Appends a selected unit to `msg.units` of any input message.

### Inputs
: context (string) : Configures unit (`"unit"`) if provided.
: payload (any) : Input payload to pass through unchanged.

### Outputs
: payload (any) : Original payload.
: units (string) : Selected unit (e.g., °F, %RH, inH₂O).

### Details
Appends `msg.units` to any input message with a unit selected in the editor or set via `msg.context = "unit"` with a valid unit string. Supports units like °C, °F, %RH, inH₂O, CFM for HVAC and control systems. Outputs only when `msg.payload` or `msg.units` changes. Stores `lastUnit` and `lastPayload` in context for persistence. Editor changes require redeployment; message updates apply immediately and are shown in the "Changed Runtime Values" section. Used to label sensor data for downstream processing.

Configuration (set in editor):
: unit (string) : Unit to append (default: °F).
: name (string) : Optional display name.

### Error Handling
- Invalid message (e.g., `msg` undefined): No output, red status (`missing message`).
- Invalid `msg.context` or missing `msg.payload` for config: No output, yellow status (`unknown context`).
- Invalid unit (not in valid list): No output, red status (`invalid unit`).
- Processing error: No output, red status (`processing error`).
- Invalid configuration (invalid unit): No output, red status (`invalid unit, using °F`).

### Status
- Green (dot): Initial configuration or unit update (e.g., `unit: °F`).
- Blue (dot): Outputs when payload or unit changes (e.g., `in: 45.20, out: %RH`).
- Blue (ring): Outputs when unchanged (e.g., `in: 45.20, out: %RH`).
- Red (ring): Errors (e.g., `missing message`, `invalid unit`, `processing error`).
- Yellow (ring): Unknown context (e.g., `unknown context`).

### References
- [Node-RED Documentation](https://nodered.org/docs/)
- [GitHub Repository](https://github.com/BldgBlocks/node-red-contrib-buildingblocks-control.git)
</script>